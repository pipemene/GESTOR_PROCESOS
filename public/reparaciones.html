<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Revisi√≥n de Orden | Blue Home Reparaciones</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h4 class="text-primary fw-bold">üîß Revisi√≥n de Orden (Dayan)</h4>
      <button id="btnVolverDashboard" class="btn btn-secondary">‚Üê Volver al Dashboard</button>
    </div>

    <div id="ordenInfo" class="mb-4 p-3 bg-white rounded shadow-sm">
      <p><b>C√≥digo:</b> <span id="ordenCodigo"></span></p>
      <p><b>Arrendatario:</b> <span id="ordenArrendatario"></span></p>
      <p><b>T√©cnico:</b> <span id="ordenTecnico"></span></p>
      <p><b>Estado:</b> <span id="ordenEstado" class="badge bg-warning text-dark"></span></p>
      <p><b>Descripci√≥n:</b> <span id="ordenDescripcion"></span></p>
    </div>

    <h5>üí∞ Detalle de Costos</h5>
    <div class="row mb-3">
      <div class="col-md-6">
        <label>Materiales Utilizados:</label>
        <textarea id="materiales" class="form-control" placeholder="Ejemplo: silicona, pintura, pegante, etc."></textarea>
      </div>
      <div class="col-md-6">
        <label>Valor Total (COP):</label>
        <input type="number" id="valorTotal" class="form-control" placeholder="Ejemplo: 150000" />
      </div>
    </div>

    <label>Observaciones y An√°lisis T√©cnico:</label>
    <textarea id="observaciones" class="form-control mb-3" rows="3" placeholder="Ejemplo: se detect√≥ da√±o en muro, se reemplaz√≥ accesorio..."></textarea>

    <h5>‚úçÔ∏è Firma del Revisor (Dayan)</h5>
    <canvas id="firmaCanvas" width="400" height="150" class="border border-secondary bg-white rounded mb-2"></canvas><br>
    <button class="btn btn-sm btn-danger" onclick="limpiarFirma()">Limpiar</button>
    <button class="btn btn-sm btn-primary" onclick="guardarFirma()">Guardar Firma</button>

    <div class="text-center mt-4">
      <button class="btn btn-success btn-lg" onclick="aprobarOrden()">‚úÖ Enviar a Facturaci√≥n</button>
    </div>
  </div>

  <script>
    const codigo = localStorage.getItem("ordenActual");
    const rol = "reparaciones";

    document.getElementById("btnVolverDashboard").addEventListener("click", () => {
      window.location.href = "dashboard.html";
    });

    // üîπ Limpiar firma
    function limpiarFirma() {
      const canvas = document.getElementById("firmaCanvas");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // üîπ Guardar firma en Drive
    async function guardarFirma() {
      const canvas = document.getElementById("firmaCanvas");
      const firma = canvas.toDataURL("image/png");
      await fetch(`/api/orders/${codigo}/sign`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ firmaInquilino: firma }) // reutilizamos campo firma
      });
      alert("‚úçÔ∏è Firma guardada correctamente");
    }

    // üîπ Guardar revisi√≥n y enviar a facturaci√≥n
    async function aprobarOrden() {
      if (!confirm("¬øConfirmas enviar esta orden al √°rea de facturaci√≥n?")) return;

      const materiales = document.getElementById("materiales").value;
      const observaciones = document.getElementById("observaciones").value;
      const valor = document.getElementById("valorTotal").value;

      // Guardamos observaciones y valor
      await fetch(`/api/orders/${codigo}/feedback`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ materiales, trabajo: `Valor total: $${valor} COP - Observaciones: ${observaciones}` })
      });

      // Actualizamos estado a Revisada (Reparaciones)
      await fetch(`/api/orders/${codigo}/finish`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nuevoEstado: "Revisada (Reparaciones)" })
      });

      alert("‚úÖ Orden enviada a Facturaci√≥n correctamente.");
      window.location.href = "dashboard.html";
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Orden de Trabajo | Blue Home Gestor</title>
  <link rel="stylesheet" href="assets/css/estilos.css" />
  <style>
    body { background:#f6f8fb; font-family:"Segoe UI",sans-serif; }
    header {
      background:linear-gradient(90deg,#004aad,#2196f3);
      color:#fff; display:flex; align-items:center;
      justify-content:space-between; padding:12px 24px;
      box-shadow:0 2px 8px rgba(0,0,0,0.2);
    }
    .logo { height:42px; }
    main { padding:24px; max-width:1000px; margin:0 auto; }
    h2,h3{color:#004aad;margin:0 0 12px;}
    .card{background:#fff;border-radius:10px;padding:18px;margin-bottom:18px;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);}
    .info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:10px 18px;font-size:15px;}
    .info-item b{color:#004aad;min-width:95px;display:inline-block;}
    input[type="file"],input[type="text"],textarea{
      width:100%;padding:8px 10px;border:1px solid #cfd6e4;border-radius:8px;
      font-size:14px;outline:none;background:#fafafa;
    }
    textarea{min-height:100px;resize:vertical;}
    .btn{border:none;border-radius:8px;padding:9px 14px;cursor:pointer;font-weight:600;}
    .btn-primary{background:#004aad;color:#fff;} .btn-primary:hover{background:#1f64d1;}
    .btn-muted{background:#6c757d;color:#fff;} .btn-muted:hover{background:#5a6268;}
    .btn-success{background:#2ecc71;color:#fff;}
    .btn-danger{background:#e74c3c;color:#fff;}
    .signature-wrap{border:2px dashed #bfc6d8;border-radius:10px;background:#fff;height:220px;}
    #firmaCanvas{width:100%;height:100%;display:block;border-radius:8px;background:#fff;}
    .row-actions{display:flex;gap:10px;flex-wrap:wrap;}
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:10px;">
      <img src="assets/img/logo-blanco.png" class="logo" alt="Blue Home" />
      <h2>Orden de Trabajo</h2>
    </div>
    <button class="btn btn-muted" id="btnBack">‚Üê Volver</button>
  </header>

  <main>
    <!-- INFO -->
    <div class="card">
      <div class="info-grid">
        <div class="info-item"><b>C√≥digo:</b> <span id="codigo">‚Äî</span></div>
        <div class="info-item"><b>Arrendatario:</b> <span id="cliente">‚Äî</span></div>
        <div class="info-item"><b>Tel√©fono:</b> <span id="telefono">‚Äî</span></div>
        <div class="info-item"><b>T√©cnico:</b> <span id="tecnico">‚Äî</span></div>
        <div class="info-item"><b>Estado:</b> <span id="estado">‚Äî</span></div>
      </div>
      <p style="margin-top:10px;"><b>Descripci√≥n:</b> <span id="descripcion">‚Äî</span></p>
    </div>

    <!-- FOTOS -->
    <div class="card">
      <h3>üì∏ Evidencias del trabajo</h3>
      <label><b>Foto Antes:</b></label>
      <input type="file" id="fotoAntes" accept="image/*"/>
      <label style="margin-top:8px;"><b>Foto Despu√©s:</b></label>
      <input type="file" id="fotoDespues" accept="image/*"/>
      <div class="row-actions" style="margin-top:10px;">
        <button class="btn btn-primary" id="btnSubirFotos">üì§ Subir Fotos</button>
      </div>
    </div>

    <!-- RETRO -->
    <div class="card">
      <h3>üß∞ Materiales y Trabajo Realizado</h3>
      <textarea id="materiales" placeholder="Describe materiales o trabajos realizados..."></textarea>
      <textarea id="observaciones" placeholder="Observaciones o comentarios..."></textarea>
      <div class="row-actions">
        <button class="btn btn-primary" id="btnGuardarRetro">üíæ Guardar Retroalimentaci√≥n</button>
      </div>
    </div>

    <!-- FIRMA -->
    <div class="card">
      <h3>‚úçÔ∏è Firma del Inquilino</h3>
      <input type="text" id="nombreFirmante" placeholder="Nombre del firmante (Ej: Juan P√©rez)" />
      <div class="signature-wrap" style="margin-top:8px;">
        <canvas id="firmaCanvas"></canvas>
      </div>
      <div class="row-actions" style="margin-top:10px;">
        <button class="btn btn-danger" id="btnLimpiarFirma">Limpiar</button>
        <button class="btn btn-primary" id="btnGuardarFirma">üíæ Guardar Firma</button>
      </div>
    </div>

    <!-- FINALIZAR -->
    <div style="text-align:center; margin-top:12px;">
      <button class="btn btn-success" id="btnFinalizar">‚úÖ Finalizar Orden</button>
    </div>
  </main>

  <script>
    const API = "/api/orders";
    const codigo = new URLSearchParams(location.search).get("codigo");

    document.getElementById("btnBack").onclick = () => location.href = "ordenes.html";

    // ===== CARGAR ORDEN =====
    async function cargarOrden() {
      try {
        const r = await fetch(API);
        const all = await r.json();
        const o = all.find(x =>
          (x.codigo && x.codigo.trim() === codigo) ||
          (x["C√≥digo"] && x["C√≥digo"].trim() === codigo) ||
          (x["c√≥digo"] && x["c√≥digo"].trim() === codigo)
        );
        if (!o) return alert("No se encontr√≥ la orden.");

        document.getElementById("cliente").textContent = o.cliente || o.Cliente || o.inquilino || "‚Äî";
        document.getElementById("telefono").textContent = o.telefono || "‚Äî";
        document.getElementById("codigo").textContent = codigo;
        document.getElementById("tecnico").textContent = o.tecnico || "Sin asignar";
        document.getElementById("estado").textContent = o.estado || "Pendiente";
        document.getElementById("descripcion").textContent = o.descripcion || "‚Äî";
      } catch (err) {
        console.error(err);
        alert("Error al cargar la orden.");
      }
    }

    // ===== SUBIR FOTOS A DRIVE =====
    document.getElementById("btnSubirFotos").onclick = async () => {
      const antes = document.getElementById("fotoAntes").files[0];
      const despues = document.getElementById("fotoDespues").files[0];
      if (!antes && !despues) return alert("Selecciona al menos una foto.");

      try {
        const formData = new FormData();
        if (antes) formData.append("fotoAntes", antes);
        if (despues) formData.append("fotoDespues", despues);

        const res = await fetch(`${API}/${codigo}/upload`, {
          method: "POST",
          body: formData,
        });
        const result = await res.json();
        alert(result.ok ? "‚úÖ Fotos subidas correctamente." : "‚ùå Error al subir fotos.");
      } catch (e) {
        console.error(e);
        alert("Error al conectar con el servidor (Drive).");
      }
    };

    // ===== GUARDAR RETROALIMENTACI√ìN =====
    document.getElementById("btnGuardarRetro").onclick = async () => {
      const materiales = document.getElementById("materiales").value.trim();
      const observaciones = document.getElementById("observaciones").value.trim();

      try {
        const res = await fetch(`${API}/${codigo}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ materiales, observaciones }),
        });
        const result = await res.json();
        alert(result.ok ? "üíæ Retroalimentaci√≥n guardada." : "‚ùå Error al guardar.");
      } catch (e) {
        console.error(e);
        alert("Error al conectar con el servidor (retroalimentaci√≥n).");
      }
    };

    // ===== FIRMA =====
    const canvas = document.getElementById("firmaCanvas");
    const ctx = canvas.getContext("2d");
    function resizeCanvas() {
      const rect = canvas.parentElement.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
    }
    resizeCanvas(); window.addEventListener("resize", resizeCanvas);
    let dib = false;
    canvas.addEventListener("mousedown", e => { dib = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); });
    canvas.addEventListener("mousemove", e => { if (dib){ ctx.lineTo(e.offsetX,e.offsetY); ctx.stroke(); } });
    window.addEventListener("mouseup", () => dib = false);
    document.getElementById("btnLimpiarFirma").onclick = () => ctx.clearRect(0,0,canvas.width,canvas.height);

    document.getElementById("btnGuardarFirma").onclick = async () => {
      const nombre = document.getElementById("nombreFirmante").value.trim();
      if (!nombre) return alert("Ingresa el nombre del firmante.");
      const data = canvas.toDataURL("image/png");
      try {
        const res = await fetch(`${API}/${codigo}/firma`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nombre, firma: data }),
        });
        const r = await res.json();
        alert(r.ok ? "‚úÖ Firma guardada correctamente." : "‚ùå Error al guardar firma.");
      } catch (e) {
        console.error(e);
        alert("Error al conectar con el servidor (firma).");
      }
    };

    // ===== FINALIZAR =====
    document.getElementById("btnFinalizar").onclick = async () => {
      if (!confirm("¬øFinalizar esta orden?")) return;
      try {
        const r = await fetch(`${API}/${codigo}/finish`, { method:"POST" });
        const out = await r.json();
        if (out.ok) {
          alert("‚úÖ Orden finalizada correctamente.");
          location.href = "ordenes.html";
        } else {
          alert("‚ùå Error al finalizar la orden.");
        }
      } catch (e) {
        console.error(e);
        alert("Error al conectar con el servidor (finalizar).");
      }
    };

    cargarOrden();
  </script>
</body>
</html>

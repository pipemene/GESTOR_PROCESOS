<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Orden de Trabajo | Blue Home Gestor</title>
  <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAExElEQVRYR8WXW2wUVRTGf3fm5mYz3xjLZC1pDdg2Ai2CkEK2FgkLJgAsoEtAhgQEQbQCiIoC6aAbQJZgi6BaAqWgFAoQZIVotBAIWQsKbg7iR3Xv0n53dPehcbOzmTH33ufueXPOmQ8YBl4PM7MIHjPWr4zDdJbxFCrA0ogW+c4LKhkc0MGqgJ9Hhs3o/FfLQ4ix1bsIQHZzmAvMkzKqJZbVgTt2IXnAwUoI6MMeO7tuLCgQG7RyBdEmDQyP+u2v4ZnAY0pnnKM1xkENMEcpmD1r9XWOhAfwBy26X9XQb3EEfCD8MkHBDMCbwxnQzoZ1qKYvEPV4Qjo0bFsGLwUyN7WjZW1JvPvSfbQFcO7TK99EJ1PQZbpw8xgOAkXRmucNUbLLipKifMKctElNfNIAgLknAgS0CtJx7NEKnFoX8DKSodYMd/SlQocPYo5FFjzvZbyjj53d+g2VEkErxjz6uFnxWZsZ0hkqTq0Vv1JbTZS4bBuvAhQcrNwRUSfmuEhVM7+5BKoAhF1m0UeOHgkJBTZwTWi4AY2KGGqJImQmdRIa7yp00kbAoPY+XgeDYZ2zEqt9kg4p50F/k5GJAWncRnvBhnFsk+2XbAav0DlfaGSJMK2GSdlDsnj4SwhvEsi2RZxAqgUfgj2oBCmNfH/3vwYAjjCVhuRH1MKo7quQayv7RQRoZPc7R8DPxRDXA9Rvb5UkjzyaGAh9g7MML1YZ1ig+I4mkfgdr+2dLfMnZ2x4ldS1iUcdK1PKgq1Ex8Gv+8OENttBeX2f1cXZ7UPh2FuDPLddUs1UchSHYYyUR+poVQqfHIg0PTCsiut4CgogimFCVG7q4xM4ZyICzJqQ+ap5RdyxDTSnt0Z0sI6c6vpcgYlKZY19FjMyilOdbK4qJRX9/SwMLVg6raArU7ML7FAcVUm26ScT3f91bVReMBOb12Y19c8OMR7pR6Xsn3U/hVoF3c/Gvb78QWly6SL5A7yZs0G2exwJqpU5p2eZzD7U8dwsxsl+y17EqZbqZt1ZriA2tUKkA0y2RFhMeZJKmTVLNjrkjhbt9xQjB1lgS0wPXFvLWWqVUwVqObWOMgqI3qvYHLMsMkeZRKzeb1ch3ZLhfAG64qFPm1U6eMiLg0xQHzDWr5Up7Wc4a2tT8LlnamN5Q3ArfHn4eW60ZUlmlcG74Jf8AC9bxQhpeULAAAAAElFTkSuQmCC" />
  <style>
    body { background:#f5f7fb; font-family:"Segoe UI",sans-serif; margin:0; }
    header { background:#004aad; color:#fff; display:flex; align-items:center; justify-content:space-between; padding:12px 20px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    header img { height:42px; }
    header h1 { font-size:20px; font-weight:600; margin:0; }

    main { max-width:960px; margin:24px auto; padding:0 16px; }

    .card { background:#fff; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.08); padding:20px; margin-bottom:20px; }
    h2,h3 { color:#004aad; margin:0 0 12px; }

    .info-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:10px; font-size:15px; }
    .info-item b { color:#004aad; }

    input[type="file"],input[type="text"],textarea {
      width:100%; border:1px solid #cfd6e4; border-radius:8px; padding:8px 10px; font-size:14px; outline:none;
    }
    textarea { min-height:100px; resize:vertical; }

    .btn { border:none; border-radius:8px; padding:9px 14px; cursor:pointer; font-weight:600; font-size:14px; }
    .btn-primary{ background:#004aad; color:#fff; } .btn-primary:hover{ background:#2563eb; }
    .btn-muted{ background:#6c757d; color:#fff; } .btn-muted:hover{ background:#5a6268; }
    .btn-success{ background:#2ecc71; color:#fff; } .btn-danger{ background:#e74c3c; color:#fff; }
    .btn:disabled{ opacity:0.6; cursor:not-allowed; }

    .signature-wrap{ border:2px dashed #bfc6d8; border-radius:10px; background:#fff; height:220px; }
    #firmaCanvas{ width:100%; height:100%; display:block; border-radius:8px; background:#fff; }

    .row-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .center{text-align:center;}
  </style>
</head>

<body>
  <header>
    <div style="display:flex;align-items:center;gap:10px;">
      <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAExElEQVRYR8WXW2wUVRTGf3fm5mYz3xjLZC1pDdg2Ai2CkEK2FgkLJgAsoEtAhgQEQbQCiIoC6aAbQJZgi6BaAqWgFAoQZIVotBAIWQsKbg7iR3Xv0n53dPehcbOzmTH33ufueXPOmQ8YBl4PM7MIHjPWr4zDdJbxFCrA0ogW+c4LKhkc0MGqgJ9Hhs3o/FfLQ4ix1bsIQHZzmAvMkzKqJZbVgTt2IXnAwUoI6MMeO7tuLCgQG7RyBdEmDQyP+u2v4ZnAY0pnnKM1xkENMEcpmD1r9XWOhAfwBy26X9XQb3EEfCD8MkHBDMCbwxnQzoZ1qKYvEPV4Qjo0bFsGLwUyN7WjZW1JvPvSfbQFcO7TK99EJ1PQZbpw8xgOAkXRmucNUbLLipKifMKctElNfNIAgLknAgS0CtJx7NEKnFoX8DKSodYMd/SlQocPYo5FFjzvZbyjj53d+g2VEkErxjz6uFnxWZsZ0hkqTq0Vv1JbTZS4bBuvAhQcrNwRUSfmuEhVM7+5BKoAhF1m0UeOHgkJBTZwTWi4AY2KGGqJImQmdRIa7yp00kbAoPY+XgeDYZ2zEqt9kg4p50F/k5GJAWncRnvBhnFsk+2XbAav0DlfaGSJMK2GSdlDsnj4SwhvEsi2RZxAqgUfgj2oBCmNfH/3vwYAjjCVhuRH1MKo7quQayv7RQRoZPc7R8DPxRDXA9Rvb5UkjzyaGAh9g7MML1YZ1ig+I4mkfgdr+2dLfMnZ2x4ldS1iUcdK1PKgq1Ex8Gv+8OENttBeX2f1cXZ7UPh2FuDPLddUs1UchSHYYyUR+poVQqfHIg0PTCsiut4CgogimFCVG7q4xM4ZyICzJqQ+ap5RdyxDTSnt0Z0sI6c6vpcgYlKZY19FjMyilOdbK4qJRX9/SwMLVg6raArU7ML7FAcVUm26ScT3f91bVReMBOb12Y19c8OMR7pR6Xsn3U/hVoF3c/Gvb78QWly6SL5A7yZs0G2exwJqpU5p2eZzD7U8dwsxsl+y17EqZbqZt1ZriA2tUKkA0y2RFhMeZJKmTVLNjrkjhbt9xQjB1lgS0wPXFvLWWqVUwVqObWOMgqI3qvYHLMsMkeZRKzeb1ch3ZLhfAG64qFPm1U6eMiLg0xQHzDWr5Up7Wc4a2tT8LlnamN5Q3ArfHn4eW60ZUlmlcG74Jf8AC9bxQhpeULAAAAAElFTkSuQmCC" alt="Blue Home Inmobiliaria" />
      <h1>Orden de Trabajo</h1>
    </div>
    <button class="btn btn-muted" id="btnBack">‚Üê Volver</button>
  </header>

  <main>
    <!-- INFO -->
    <div class="card">
      <div class="info-grid">
        <div class="info-item"><b>C√≥digo:</b> <span id="codigo">‚Äî</span></div>
        <div class="info-item"><b>Arrendatario:</b> <span id="cliente">‚Äî</span></div>
        <div class="info-item"><b>Tel√©fono:</b> <span id="telefono">‚Äî</span></div>
        <div class="info-item"><b>T√©cnico:</b> <span id="tecnico">‚Äî</span></div>
        <div class="info-item"><b>Estado:</b> <span id="estado">‚Äî</span></div>
      </div>
      <p style="margin-top:10px;"><b>Descripci√≥n:</b> <span id="descripcion">‚Äî</span></p>
    </div>

    <!-- FOTOS -->
    <div class="card">
      <h3>üì∏ Evidencias del trabajo</h3>
      <label><b>Foto Antes:</b></label>
      <input type="file" id="fotoAntes" accept="image/*"/>
      <label style="margin-top:8px;"><b>Foto Despu√©s:</b></label>
      <input type="file" id="fotoDespues" accept="image/*"/>
      <div class="row-actions">
        <button class="btn btn-primary" id="btnSubirFotos">üì§ Subir Fotos</button>
      </div>
    </div>

    <!-- RETRO -->
    <div class="card">
      <h3>ü™ö Materiales y Trabajo Realizado</h3>
      <textarea id="materiales" placeholder="Describe materiales o trabajos realizados..."></textarea>
      <textarea id="observaciones" placeholder="Observaciones o comentarios..."></textarea>
      <div class="row-actions">
        <button class="btn btn-primary" id="btnGuardarRetro">üíæ Guardar Retroalimentaci√≥n</button>
      </div>
    </div>

    <!-- FIRMA -->
    <div class="card">
      <h3>‚úçÔ∏è Firma del Inquilino</h3>
      <input type="text" id="nombreFirmante" placeholder="Nombre del firmante (Ej: Juan P√©rez)" />
      <div class="signature-wrap" style="margin-top:8px;">
        <canvas id="firmaCanvas"></canvas>
      </div>
      <div class="row-actions">
        <button class="btn btn-danger" id="btnLimpiarFirma">Limpiar</button>
        <button class="btn btn-primary" id="btnGuardarFirma">üíæ Guardar Firma</button>
      </div>
    </div>

    <div class="center">
      <button class="btn btn-success" id="btnFinalizar">‚úÖ Finalizar Orden</button>
    </div>
  </main>

  <script>
    const API = "/api/orders";
    const q = new URLSearchParams(location.search);
    const codigoParam = q.get("codigo")?.trim() || "";

    document.getElementById("btnBack").onclick = () => location.href = "ordenes.html";

    // ===== CARGAR ORDEN =====
    async function cargarOrden() {
      try {
        const r = await fetch(API);
        const all = await r.json();
        console.log("üì¶ Total √≥rdenes cargadas:", all.length);

        const o = all.find(x => {
          const keys = Object.keys(x);
          const keyCodigo = keys.find(k => k.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"") === "codigo");
          if (!keyCodigo) return false;
          const codeInRow = (x[keyCodigo] || "").trim().toLowerCase();
          return codeInRow === codigoParam.trim().toLowerCase();
        });

        if (!o) {
          alert("No se encontr√≥ la orden. Verifica que el c√≥digo exista en la hoja.");
          return;
        }

        console.log("‚úÖ Orden encontrada:", o);

        document.getElementById("cliente").textContent = o.cliente || o.inquilino || "‚Äî";
        document.getElementById("telefono").textContent = o.telefono || "‚Äî";
        document.getElementById("codigo").textContent = o.codigo || o.C√≥digo || "‚Äî";
        document.getElementById("tecnico").textContent = o.tecnico || "‚Äî";
        document.getElementById("estado").textContent = o.estado || "‚Äî";
        document.getElementById("descripcion").textContent = o.descripcion || "‚Äî";
      } catch (e) {
        console.error("‚ùå Error cargando orden:", e);
        alert("Error al cargar la orden desde el servidor.");
      }
    }

    // ===== SUBIR FOTOS =====
    document.getElementById("btnSubirFotos").onclick = async () => {
      const antes = document.getElementById("fotoAntes").files[0];
      const despues = document.getElementById("fotoDespues").files[0];
      if (!antes && !despues) return alert("Selecciona al menos una foto.");

      try {
        const fd = new FormData();
        if (antes) fd.append("fotoAntes", antes);
        if (despues) fd.append("fotoDespues", despues);
        const r = await fetch(`${API}/${codigoParam}/upload`, { method: "POST", body: fd });
        const j = await r.json();
        alert(j.ok ? "‚úÖ Fotos subidas correctamente." : "‚ùå Error al subir fotos.");
      } catch (e) {
        console.error(e);
        alert("Error al subir fotos.");
      }
    };

    // ===== GUARDAR RETRO =====
    document.getElementById("btnGuardarRetro").onclick = async () => {
      const materiales = document.getElementById("materiales").value.trim();
      const observaciones = document.getElementById("observaciones").value.trim();
      try {
        const res = await fetch(`${API}/${codigoParam}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ materiales, observaciones })
        });
        const out = await res.json();
        alert(out.ok ? "üíæ Retroalimentaci√≥n guardada." : "‚ùå Error al guardar.");
      } catch (e) {
        console.error(e);
        alert("Error al conectar con el servidor (retroalimentaci√≥n).");
      }
    };

    // ===== FIRMA =====
    const canvas = document.getElementById("firmaCanvas");
    const ctx = canvas.getContext("2d");
    function resizeCanvas() {
      const rect = canvas.parentElement.getBoundingClientRect();
      const ratio = window.devicePixelRatio || 1;
      canvas.width = rect.width * ratio;
      canvas.height = rect.height * ratio;
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      ctx.lineWidth = 2; ctx.lineCap = "round"; ctx.strokeStyle = "#111827";
    }
    resizeCanvas(); window.addEventListener("resize", resizeCanvas);

    let dibujando = false;
    function getPos(e){ const r=canvas.getBoundingClientRect(); if(e.touches&&e.touches.length) e=e.touches[0]; return {x:e.clientX-r.left,y:e.clientY-r.top}; }
    function start(e){ dibujando=true; const p=getPos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); e.preventDefault(); }
    function draw(e){ if(!dibujando) return; const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); e.preventDefault(); }
    function end(){ dibujando=false; }
    canvas.addEventListener("mousedown",start); canvas.addEventListener("mousemove",draw); window.addEventListener("mouseup",end);
    canvas.addEventListener("touchstart",start,{passive:false}); canvas.addEventListener("touchmove",draw,{passive:false}); canvas.addEventListener("touchend",end);

    document.getElementById("btnLimpiarFirma").onclick = () => { ctx.clearRect(0,0,canvas.width,canvas.height); resizeCanvas(); };

    document.getElementById("btnGuardarFirma").onclick = async () => {
      const nombreFirmante = document.getElementById("nombreFirmante").value.trim();
      if (!nombreFirmante) return alert("Ingresa el nombre del firmante.");
      const firmaData = canvas.toDataURL("image/png");
      try {
        const r = await fetch(`${API}/${codigoParam}/firma`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nombre: nombreFirmante, firma: firmaData })
        });
        const out = await r.json();
        alert(out.ok ? "‚úÖ Firma guardada correctamente." : "‚ùå No se pudo guardar la firma.");
      } catch (e) {
        console.error(e);
        alert("Error al conectar con el servidor (firma).");
      }
    };

    // ===== FINALIZAR =====
    document.getElementById("btnFinalizar").onclick = async () => {
      if (!confirm("¬øFinalizar esta orden?")) return;
      try {
        const r = await fetch(`${API}/${codigoParam}/finish`, { method:"POST" });
        const out = await r.json();
        if (out.ok) {
          alert("‚úÖ Orden finalizada correctamente.");
          location.href = "ordenes.html";
        } else alert("‚ùå Error al finalizar la orden.");
      } catch (e) {
        console.error(e);
        alert("Error al conectar con el servidor (finalizar).");
      }
    };

    cargarOrden();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Orden de Trabajo | Blue Home Gestor</title>
  <link rel="stylesheet" href="assets/css/estilos.css" />
  <style>
    body { background-color: #f5f7fa; font-family: "Segoe UI", sans-serif; }
    .header {
      background-color: #004aad; color: white;
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 30px; box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    .logo { height: 45px; }
    main { padding: 30px; max-width: 900px; margin: auto; }
    h2 { color: #004aad; margin-bottom: 20px; }
    .card {
      background: white; border-radius: 10px; padding: 20px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1); margin-bottom: 25px;
    }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input, textarea, select {
      width: 100%; padding: 8px; border: 1px solid #ccc;
      border-radius: 6px; margin-top: 5px;
    }
    button {
      border: none; border-radius: 8px; padding: 10px 18px; cursor: pointer;
      margin-top: 10px; font-weight: bold;
    }
    .btn-primary { background-color: #004aad; color: white; }
    .btn-primary:hover { background-color: #1f64d1; }
    .btn-success { background-color: #28a745; color: white; }
    .btn-success:hover { background-color: #218838; }
    .btn-danger { background-color: #dc3545; color: white; }
    .btn-secondary { background-color: #6c757d; color: white; }
    canvas { border: 2px solid #ccc; border-radius: 10px; width: 100%; height: 200px; }
  </style>
</head>

<body>
  <header class="header">
    <div class="logo-container">
      <img src="assets/img/logo-blanco.png" class="logo" alt="Blue Home" />
      <h2>Blue Home Gestor</h2>
    </div>
    <button class="btn-secondary" onclick="window.location.href='dashboard.html'">‚Üê Volver al Dashboard</button>
  </header>

  <main>
    <h2>üßæ Orden de Trabajo</h2>

    <div class="card">
      <p><b>C√≥digo:</b> <span id="codigo"></span></p>
      <p><b>Arrendatario:</b> <span id="inquilino"></span></p>
      <p><b>Tel√©fono:</b> <span id="telefono"></span></p>
      <p><b>T√©cnico:</b> <span id="tecnico"></span></p>
      <p><b>Estado:</b> <span id="estado"></span></p>
      <p><b>Descripci√≥n:</b> <span id="descripcion"></span></p>
    </div>

    <div class="card">
      <h3>üì∏ Evidencias del trabajo</h3>
      <label>Foto Antes:</label>
      <input type="file" id="fotoAntes" accept="image/*" />
      <label>Foto Despu√©s:</label>
      <input type="file" id="fotoDespues" accept="image/*" />
      <button class="btn-primary" id="subirFotos">üì§ Subir Fotos</button>
    </div>

    <div class="card">
      <h3>ü™ö Materiales y Trabajo Realizado</h3>
      <textarea id="materiales" rows="3" placeholder="Describe materiales o trabajos realizados..."></textarea>
      <textarea id="observaciones" rows="3" placeholder="Observaciones o comentarios..."></textarea>
      <button class="btn-primary" id="guardarDatos">üíæ Guardar Retroalimentaci√≥n</button>
    </div>

    <div class="card">
      <h3>‚úçÔ∏è Firma del Inquilino</h3>
      <label>Nombre del firmante:</label>
      <input type="text" id="nombreFirmante" placeholder="Ej: Juan P√©rez" />
      <canvas id="canvasFirma"></canvas>
      <div style="display:flex; gap:10px; margin-top:10px;">
        <button class="btn-danger" id="limpiarFirma">Limpiar</button>
        <button class="btn-primary" id="guardarFirma">Guardar Firma</button>
      </div>
    </div>

    <div style="text-align:center;">
      <button class="btn-success" id="finalizarOrden">‚úÖ Finalizar Orden</button>
    </div>
  </main>

  <script>
    const params = new URLSearchParams(window.location.search);
    const fila = params.get("fila");
    const codigo = params.get("codigo");
    const API_URL = "/api/orders";

    // Cargar datos de la orden
    async function cargarOrden() {
      try {
        const res = await fetch(`${API_URL}/${fila}`);
        const data = await res.json();

        // Mostrar datos (tolerando nombres de columnas con may√∫sculas)
        document.getElementById("codigo").innerText = data.codigo || data.C√≥digo || codigo;
        document.getElementById("inquilino").innerText = data.inquilino || data.Inquilino || data.Cliente || "‚Äî";
        document.getElementById("telefono").innerText = data.telefono || data.Tel√©fono || "‚Äî";
        document.getElementById("tecnico").innerText = data.tecnico || data.T√©cnico || "‚Äî";
        document.getElementById("estado").innerText = data.estado || data.Estado || "Pendiente";
        document.getElementById("descripcion").innerText = data.descripcion || data.Descripci√≥n || "";
      } catch (err) {
        console.error(err);
        alert("Error al cargar la orden.");
      }
    }

    // Firma digital
    const canvas = document.getElementById("canvasFirma");
    const ctx = canvas.getContext("2d");
    let dibujando = false;

    canvas.addEventListener("mousedown", e => { dibujando = true; dibujar(e); });
    canvas.addEventListener("mouseup", () => (dibujando = false, ctx.beginPath()));
    canvas.addEventListener("mousemove", dibujar);
    canvas.addEventListener("touchstart", e => (dibujando = true, dibujar(e.touches[0])));
    canvas.addEventListener("touchend", () => (dibujando = false, ctx.beginPath()));
    canvas.addEventListener("touchmove", e => dibujar(e.touches[0]));

    function dibujar(e) {
      if (!dibujando) return;
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      const rect = canvas.getBoundingClientRect();
      ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    document.getElementById("limpiarFirma").onclick = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    };

    document.getElementById("guardarFirma").onclick = async () => {
      const nombreFirmante = document.getElementById("nombreFirmante").value.trim();
      if (!nombreFirmante) return alert("Por favor ingrese el nombre del firmante.");
      const firmaData = canvas.toDataURL("image/png");
      const body = { fila, nombreFirmante, firmaData };
      const res = await fetch(`${API_URL}/${fila}/sign`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (data.ok) alert("‚úÖ Firma guardada correctamente.");
      else alert("‚ùå Error al guardar la firma.");
    };

    // Subir fotos
    document.getElementById("subirFotos").onclick = async () => {
      alert("Las fotos se subir√°n autom√°ticamente al Drive vinculado (pendiente de conexi√≥n).");
    };

    // Guardar observaciones
    document.getElementById("guardarDatos").onclick = async () => {
      const body = {
        fila,
        materiales: document.getElementById("materiales").value,
        observaciones: document.getElementById("observaciones").value
      };
      const res = await fetch(`${API_URL}/update`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (data.ok) alert("üíæ Informaci√≥n actualizada correctamente.");
      else alert("‚ùå Error al guardar.");
    };

    // Finalizar orden
    document.getElementById("finalizarOrden").onclick = async () => {
      if (!confirm("¬øFinalizar esta orden?")) return;
      const res = await fetch(`${API_URL}/${fila}/finish`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });
      const data = await res.json();
      if (data.ok) {
        alert("‚úÖ Orden finalizada y enviada al √°rea de revisi√≥n (Dayan).");
        window.location.href = "dashboard.html";
      } else {
        alert("‚ùå Error al finalizar la orden.");
      }
    };

    cargarOrden();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Orden de Trabajo | Blue Home Gestor</title>
  <link rel="stylesheet" href="assets/css/estilos.css" />
  <style>
    body { background-color: #f5f7fa; font-family: "Segoe UI", sans-serif; }
    header {
      background-color: #004aad; color: white;
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 30px;
    }
    .logo { height: 45px; }
    main { padding: 25px 10%; max-width: 1000px; margin: auto; }
    h2 { color: #004aad; margin: 10px 0 18px; }
    .card {
      background: white; border-radius: 10px;
      padding: 18px; margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px 18px; font-size: 15px;
    }
    .info-item b { color: #004aad; display:inline-block; min-width: 95px; }

    input[type="file"], input[type="text"], textarea {
      width: 100%; padding: 8px 10px; border: 1px solid #cfd6e4; border-radius: 8px;
      font-size: 14px; outline: none;
    }
    textarea { min-height: 100px; resize: vertical; }

    .btn {
      border: none; border-radius: 8px; padding: 9px 14px; cursor: pointer; font-weight: 600;
    }
    .btn-primary { background:#004aad; color:#fff; }
    .btn-primary:hover { background:#1f64d1; }
    .btn-muted { background:#6c757d; color:#fff; }
    .btn-muted:hover { background:#5a6268; }
    .btn-success { background:#2ecc71; color:#fff; }
    .btn-danger { background:#e74c3c; color:#fff; }

    /* Firma */
    .signature-wrap {
      border: 2px dashed #bfc6d8; border-radius: 10px; background:#fff;
      height: 220px; position: relative;
    }
    #firmaCanvas { width: 100%; height: 100%; display:block; background: #ffffff; border-radius: 8px; }
    .row-actions { display:flex; gap:10px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:10px;">
      <img src="assets/img/logo-blanco.png" class="logo" alt="Blue Home" />
      <h2>Orden de Trabajo</h2>
    </div>
    <button class="btn btn-muted" id="btnBack">← Volver</button>
  </header>

  <main>
    <!-- Información general -->
    <div class="card">
      <div class="info-grid">
        <div class="info-item"><b>Código:</b> <span id="codigo">—</span></div>
        <div class="info-item"><b>Arrendatario:</b> <span id="cliente">—</span></div>
        <div class="info-item"><b>Teléfono:</b> <span id="telefono">—</span></div>
        <div class="info-item"><b>Técnico:</b> <span id="tecnico">—</span></div>
        <div class="info-item"><b>Estado:</b> <span id="estado">—</span></div>
      </div>
      <p style="margin-top:12px;"><b>Descripción:</b> <span id="descripcion">—</span></p>
    </div>

    <!-- Fotos -->
    <div class="card">
      <h3>📸 Evidencias del trabajo</h3>
      <label><b>Foto Antes:</b></label>
      <input type="file" id="fotoAntes" accept="image/*"/>
      <label><b>Foto Después:</b></label>
      <input type="file" id="fotoDespues" accept="image/*"/>
      <div class="row-actions" style="margin-top:10px;">
        <button class="btn btn-primary" id="btnSubirFotos">📤 Subir Fotos</button>
      </div>
    </div>

    <!-- Retroalimentación -->
    <div class="card">
      <h3>🪚 Materiales y Trabajo Realizado</h3>
      <textarea id="materiales" placeholder="Describe materiales o trabajos realizados..."></textarea>
      <textarea id="observaciones" placeholder="Observaciones o comentarios..."></textarea>
      <div class="row-actions">
        <button class="btn btn-primary" id="btnGuardarRetro">💾 Guardar Retroalimentación</button>
      </div>
    </div>

    <!-- Firma -->
    <div class="card">
      <h3>✍️ Firma del Inquilino</h3>
      <input type="text" id="nombreFirmante" placeholder="Nombre del firmante (Ej: Juan Pérez)" />
      <div class="signature-wrap">
        <canvas id="firmaCanvas"></canvas>
      </div>
      <div class="row-actions" style="margin-top:10px;">
        <button class="btn btn-danger" id="btnLimpiarFirma">Limpiar</button>
        <button class="btn btn-primary" id="btnGuardarFirma">💾 Guardar Firma</button>
      </div>
    </div>

    <!-- Finalizar -->
    <div style="text-align:center; margin-top:18px;">
      <button class="btn btn-success" id="btnFinalizar">✅ Finalizar Orden</button>
    </div>
  </main>

  <script>
    const API = "/api/orders";
    const params = new URLSearchParams(location.search);
    const fila = params.get("fila");
    const codigoParam = params.get("codigo");
    document.getElementById("btnBack").onclick = () => (location.href = "ordenes.html");

    // === CARGAR ORDEN DESDE SHEETS ===
    async function cargarOrden() {
      try {
        const res = await fetch(API);
        const data = await res.json();
        const orden = data.find(o => String(o.fila) === String(fila) || o.codigo === codigoParam || o.Código === codigoParam);
        if (!orden) { alert("No se encontró la orden."); return; }

        document.getElementById("cliente").textContent = orden.cliente || orden.Cliente || orden.Arrendatario || "—";
        document.getElementById("telefono").textContent = orden.telefono || orden.Telefono || "—";
        document.getElementById("codigo").textContent = orden.codigo || orden.Código || "—";
        document.getElementById("tecnico").textContent = orden.tecnico || orden.Tecnico || "—";
        document.getElementById("estado").textContent = orden.estado || orden.Estado || "—";
        document.getElementById("descripcion").textContent = orden.descripcion || orden.Descripcion || "—";
      } catch (err) {
        console.error(err);
        alert("Error cargando la orden desde el servidor.");
      }
    }

    // === SUBIR FOTOS ===
    document.getElementById("btnSubirFotos").onclick = async () => {
      const antes = document.getElementById("fotoAntes").files[0];
      const despues = document.getElementById("fotoDespues").files[0];
      if (!antes && !despues) return alert("Selecciona al menos una foto.");
      const fd = new FormData();
      if (antes) fd.append("fotoAntes", antes);
      if (despues) fd.append("fotoDespues", despues);
      try {
        const res = await fetch(`${API}/upload?fila=${fila}`, { method: "POST", body: fd });
        const out = await res.json();
        alert(out.ok ? "✅ Fotos subidas correctamente." : "❌ Error al subir fotos.");
      } catch (e) {
        console.error(e);
        alert("Error al conectar con el servidor.");
      }
    };

    // === GUARDAR RETROALIMENTACIÓN ===
    document.getElementById("btnGuardarRetro").onclick = async () => {
      const materiales = document.getElementById("materiales").value.trim();
      const observaciones = document.getElementById("observaciones").value.trim();
      try {
        const res = await fetch(`${API}/update`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fila, materiales, observaciones }),
        });
        const out = await res.json();
        alert(out.ok ? "💾 Retroalimentación guardada." : "❌ Error al guardar.");
      } catch (err) {
        console.error(err);
        alert("Error guardando retroalimentación.");
      }
    };

    // === FIRMA ===
    const canvas = document.getElementById("firmaCanvas");
    const ctx = canvas.getContext("2d");
    function resizeCanvas() {
      const rect = canvas.parentElement.getBoundingClientRect();
      const ratio = window.devicePixelRatio || 1;
      canvas.width = rect.width * ratio;
      canvas.height = rect.height * ratio;
      canvas.style.width = rect.width + "px";
      canvas.style.height = rect.height + "px";
      ctx.scale(ratio, ratio);
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "#111827";
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);
    let dibujando = false;
    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      if (e.touches && e.touches.length) e = e.touches[0];
      return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }
    function start(e) { dibujando = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); e.preventDefault(); }
    function draw(e) { if (!dibujando) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); }
    function end() { dibujando = false; }
    canvas.addEventListener("mousedown", start);
    canvas.addEventListener("mousemove", draw);
    window.addEventListener("mouseup", end);
    canvas.addEventListener("touchstart", start, { passive: false });
    canvas.addEventListener("touchmove", draw, { passive: false });
    canvas.addEventListener("touchend", end);
    document.getElementById("btnLimpiarFirma").onclick = () => ctx.clearRect(0,0,canvas.width,canvas.height);
    document.getElementById("btnGuardarFirma").onclick = async () => {
      const nombre = document.getElementById("nombreFirmante").value.trim();
      if (!nombre) return alert("Ingresa el nombre del firmante.");
      const firma = canvas.toDataURL("image/png");
      try {
        const res = await fetch(`${API}/update`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fila, nombreFirmante: nombre, firma }),
        });
        const out = await res.json();
        alert(out.ok ? "✅ Firma guardada correctamente." : "❌ No se pudo guardar la firma.");
      } catch (err) {
        console.error(err);
        alert("Error al conectar con el servidor.");
      }
    };

    // === FINALIZAR ORDEN ===
    document.getElementById("btnFinalizar").onclick = async () => {
      if (!confirm("¿Finalizar la orden y notificar a Dayan (reparaciones@bluehomeinmo.co)?")) return;
      try {
        const res = await fetch(`${API}/update`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fila, estado: "Finalizada", notify: "reparaciones@bluehomeinmo.co" }),
        });
        const out = await res.json();
        if (out.ok) {
          alert("✅ Orden finalizada y notificada correctamente.");
          location.href = "ordenes.html";
        } else alert("❌ Error al finalizar la orden.");
      } catch (err) {
        console.error(err);
        alert("Error al conectar con el servidor.");
      }
    };

    cargarOrden();
  </script>
</body>
</html>

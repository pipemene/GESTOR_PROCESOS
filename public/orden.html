<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Orden de Trabajo | Blue Home Gestor</title>
  <link rel="stylesheet" href="assets/css/estilos.css" />
  <style>
    body { background:#f6f8fb; font-family: "Segoe UI", sans-serif; color:#0f172a; }
    header { background:#004aad; color:#fff; display:flex; align-items:center; justify-content:space-between; padding:12px 24px; gap:16px; flex-wrap:wrap; }
    .logo { height:42px; }
    main { padding:24px; max-width:1000px; margin:0 auto; }
    h2 { color:#004aad; margin:0; }
    h3 { color:#004aad; margin:0 0 12px; }
    .card { background:#fff; border-radius:10px; padding:18px; margin-bottom:18px; box-shadow:0 2px 8px rgba(0,0,0,0.08); color:#0f172a; }
    .card p, .card span { color:#0f172a; }
    .top-summary { display:flex; gap:12px; flex-wrap:wrap; font-size:13px; color:#0f172a; }
    .top-summary span {
      background:#f1f5ff;
      border:1px solid rgba(15,23,42,0.12);
      border-radius:30px;
      padding:6px 12px;
      display:flex;
      align-items:center;
      gap:6px;
      color:#0f172a;
    }
    .top-summary span::before { content: attr(data-label) ":"; font-weight:600; color:#004aad; }

    .info-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:10px 18px; font-size:15px; }
    .info-item b { color:#004aad; min-width:95px; display:inline-block; }

    input[type="file"], input[type="text"], textarea {
      width:100%; padding:8px 10px; border:1px solid #cfd6e4; border-radius:8px; font-size:14px; outline:none; color:#0f172a; background:#fff;
    }
    textarea { min-height:100px; resize:vertical; }
    input::placeholder, textarea::placeholder { color:#64748b; opacity:1; }
    label { color:#0f172a; font-weight:600; }

    .btn { border:none; border-radius:8px; padding:9px 14px; cursor:pointer; font-weight:600; transition:0.2s; }
    .btn-primary{ background:#004aad; color:#fff; } .btn-primary:hover{ background:#1f64d1; }
    .btn-muted{ background:#6c757d; color:#fff; } .btn-muted:hover{ background:#5a6268; }
    .btn-success{ background:#2ecc71; color:#fff; }
    .btn-danger{ background:#e74c3c; color:#fff; }

    .signature-wrap{ border:2px dashed #bfc6d8; border-radius:10px; background:#fff; height:220px; }
    #firmaCanvas{ width:100%; height:100%; display:block; border-radius:8px; background:#fff; }
    .row-actions{ display:flex; gap:10px; flex-wrap:wrap; }

    .status-message {
      margin-top:16px;
      padding:12px 16px;
      border-radius:10px;
      border:1px solid transparent;
      background:#f1f5f9;
      color:#0f172a;
      font-size:14px;
      text-align:left;
      display:none;
    }

    .status-message.is-visible { display:block; }
    .status-message.is-success { border-color:#16a34a; background:#ecfdf5; color:#166534; }
    .status-message.is-error { border-color:#dc2626; background:#fef2f2; color:#7f1d1d; }
    .status-message.is-info { border-color:#2563eb; background:#eff6ff; color:#1d4ed8; }

    .status-message a { color: inherit; text-decoration: underline; word-break: break-all; }

    @media (max-width: 768px) {
      header { flex-direction: column; align-items:flex-start; }
      header > button { align-self: stretch; }
      .top-summary { width:100%; }
      .top-summary span { flex:1 1 45%; justify-content:center; }
      main { padding:20px 16px 32px; }
    }

    @media (max-width: 480px) {
      .top-summary { flex-direction:column; }
      .top-summary span { flex:1 1 auto; width:100%; }
    }
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <div style="display:flex;align-items:center;gap:10px;">
        <img src="assets/img/logo-blanco.png" class="logo" alt="Blue Home" />
        <div>
          <h2>Orden de Trabajo</h2>
          <p id="orderBreadcrumb" style="margin:2px 0 0;font-size:13px;color:rgba(255,255,255,0.85);">
            Cargando informaciÃ³n...
          </p>
        </div>
      </div>
      <div class="top-summary" id="topSummary">
        <span data-label="CÃ³digo" id="topCodigo">â€”</span>
        <span data-label="Cliente" id="topCliente">â€”</span>
        <span data-label="TelÃ©fono" id="topTelefono">â€”</span>
        <span data-label="Estado" id="topEstado">â€”</span>
      </div>
    </div>
    <button class="btn btn-muted" id="btnBack">â† Volver</button>
  </header>

  <main>
    <!-- INFO -->
    <div class="card">
      <div class="info-grid">
        <div class="info-item"><b>CÃ³digo:</b> <span id="codigo">â€”</span></div>
        <div class="info-item"><b>Arrendatario:</b> <span id="cliente">â€”</span></div>
        <div class="info-item"><b>TelÃ©fono:</b> <span id="telefono">â€”</span></div>
        <div class="info-item"><b>TÃ©cnico:</b> <span id="tecnico">â€”</span></div>
        <div class="info-item"><b>Estado:</b> <span id="estado">â€”</span></div>
      </div>
      <p style="margin-top:10px;"><b>DescripciÃ³n:</b> <span id="descripcion">â€”</span></p>
    </div>

    <!-- FOTOS -->
    <div class="card">
      <h3>ğŸ“¸ Evidencias del trabajo</h3>
      <label><b>Foto Antes:</b></label>
      <input type="file" id="fotoAntes" accept="image/*"/>
      <label style="margin-top:8px;"><b>Foto DespuÃ©s:</b></label>
      <input type="file" id="fotoDespues" accept="image/*"/>
    </div>

    <!-- RETRO -->
    <div class="card">
      <h3>ğŸªš Materiales y Trabajo Realizado</h3>
      <textarea id="materiales" placeholder="Describe materiales o trabajos realizados..."></textarea>
      <textarea id="observaciones" placeholder="Observaciones o comentarios..."></textarea>
    </div>

    <!-- FIRMA -->
    <div class="card">
      <h3>âœï¸ Firma del Inquilino</h3>
      <input type="text" id="nombreFirmante" placeholder="Nombre del firmante (Ej: Juan PÃ©rez)" />
      <div class="signature-wrap" style="margin-top:8px;">
        <canvas id="firmaCanvas"></canvas>
      </div>
      <div class="row-actions" style="margin-top:10px;">
        <button class="btn btn-danger" id="btnLimpiarFirma">Limpiar</button>
      </div>
    </div>

    <!-- FINALIZAR -->
    <div style="text-align:center; margin-top:12px;">
      <button class="btn btn-success" id="btnFinalizar">âœ… Finalizar Orden (Generar PDF)</button>
    </div>
    <div id="finalizacionStatus" class="status-message" role="status" aria-live="polite"></div>
  </main>

  <script>
    const API = "/api/orders";
    const q = new URLSearchParams(location.search);
    const codigo = q.get("codigo");
    document.getElementById("btnBack").onclick = () => {
      if (window.history.length > 1) {
        window.history.back();
      } else {
        location.href = "ordenes.html";
      }
    };

    const prefer = (record, keys, fallback = "") => {
      if (!record) return fallback;
      for (const key of keys) {
        if (key in record && record[key] != null && String(record[key]).trim() !== "") {
          return record[key];
        }
      }
      return fallback;
    };

    // ===== CARGAR DATOS ORDEN =====
    if (!codigo) {
      document.getElementById("orderBreadcrumb").textContent = "Sin cÃ³digo de orden";
    }

    async function cargarOrden() {
      try {
        const r = await fetch(API);
        const data = await r.json();
        const cleanCodigo = codigo ? codigo.trim() : "";
        const o = data.find(x => {
          const codeCandidate = prefer(x, [
            "codigo",
            "CÃ³digo",
            "cÃ³digo",
            "CÃ“DIGO",
            "codigoinmueble",
            "Codigo del inmueble",
            "CÃ³digo del inmueble",
            "codigo del inmueble",
            "id",
            "ID",
            "idorden",
            "orden",
          ], "");
          return String(codeCandidate).trim() === cleanCodigo;
        });
        if (!o) {
          alert("No se encontrÃ³ la orden.");
          return;
        }

        const codigoVal = prefer(o, [
          "codigo",
          "CÃ³digo",
          "cÃ³digo",
          "CÃ“DIGO",
          "codigoinmueble",
          "Codigo del inmueble",
          "CÃ³digo del inmueble",
          "codigo del inmueble",
          "id",
          "ID",
          "idorden",
          "orden",
        ], "â€”");
        const clienteVal = prefer(o, [
          "cliente",
          "Cliente",
          "inquilino",
          "Inquilino",
          "arrendatario",
          "Arrendatario",
          "nombre arrendatario",
          "Nombre arrendatario",
          "nombreinquilino",
        ], "â€”");
        const telefonoVal = prefer(o, [
          "telefono",
          "telÃ©fono",
          "Telefono",
          "TelÃ©fono",
          "celular",
          "Celular",
          "contacto",
          "Contacto",
          "telefono arrendatario",
          "Telefono arrendatario",
        ], "â€”");
        const tecnicoVal = prefer(o, ["tecnico", "TÃ©cnico", "tecnico asignado", "Tecnico Asignado", "responsable", "Responsable"], "â€”");
        const estadoVal = prefer(o, ["estado", "Estado", "estatus", "Estatus", "estado actual"], "â€”");
        const descripcionVal = prefer(o, [
          "descripcion",
          "DescripciÃ³n",
          "descripcion_reporte",
          "Reporte",
          "detalle",
          "Detalle",
          "observacion",
          "Observacion",
        ], "â€”");

        document.getElementById("codigo").textContent = codigoVal;
        document.getElementById("cliente").textContent = clienteVal;
        document.getElementById("telefono").textContent = telefonoVal;
        document.getElementById("tecnico").textContent = tecnicoVal;
        document.getElementById("estado").textContent = estadoVal;
        document.getElementById("descripcion").textContent = descripcionVal;

        document.getElementById("topCodigo").textContent = codigoVal;
        document.getElementById("topCliente").textContent = clienteVal;
        document.getElementById("topTelefono").textContent = telefonoVal;
        document.getElementById("topEstado").textContent = estadoVal;
        document.getElementById("orderBreadcrumb").textContent = `${codigoVal !== "â€”" ? "Orden " + codigoVal : "Orden"}${clienteVal !== "â€”" ? " Â· " + clienteVal : ""}`;
      } catch (e) {
        console.error(e);
        alert("Error cargando datos de la orden.");
      }
    }

    // ===== FIRMA =====
    const canvas = document.getElementById("firmaCanvas");
    const ctx = canvas.getContext("2d");
    function resizeCanvas() {
      const rect = canvas.parentElement.getBoundingClientRect();
      const ratio = window.devicePixelRatio || 1;
      canvas.width = rect.width * ratio;
      canvas.height = rect.height * ratio;
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      ctx.lineWidth = 2; ctx.lineCap = "round"; ctx.strokeStyle = "#111827";
    }
    resizeCanvas(); window.addEventListener("resize", resizeCanvas);

    let dibujando = false;
    let firmaTrazada = false;

    const setFirmaTrazada = (state) => {
      firmaTrazada = state;
    };

    function getPos(e){ const r=canvas.getBoundingClientRect(); if(e.touches&&e.touches.length) e=e.touches[0]; return {x:e.clientX-r.left, y:e.clientY-r.top}; }
    function start(e){ dibujando=true; const p=getPos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); e.preventDefault(); }
    function draw(e){ if(!dibujando) return; const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); setFirmaTrazada(true); e.preventDefault(); }
    function end(){ dibujando=false; }
    canvas.addEventListener("mousedown",start); canvas.addEventListener("mousemove",draw); window.addEventListener("mouseup",end);
    canvas.addEventListener("touchstart",start,{passive:false}); canvas.addEventListener("touchmove",draw,{passive:false}); canvas.addEventListener("touchend",end);
    document.getElementById("btnLimpiarFirma").onclick = () => { ctx.clearRect(0,0,canvas.width,canvas.height); resizeCanvas(); setFirmaTrazada(false); };

    // ===== FINALIZAR Y GENERAR PDF =====
    const btnFinalizar = document.getElementById("btnFinalizar");
    const statusBox = document.getElementById("finalizacionStatus");

    const mostrarEstado = (tipo, contenido) => {
      statusBox.className = "status-message";
      if (!contenido) {
        statusBox.textContent = "";
        statusBox.classList.remove("is-visible");
        return;
      }

      statusBox.innerHTML = contenido;
      statusBox.classList.add("is-visible");
      if (tipo === "error") statusBox.classList.add("is-error");
      else if (tipo === "success") statusBox.classList.add("is-success");
      else statusBox.classList.add("is-info");
    };

    btnFinalizar.addEventListener("click", async () => {
      if (!codigo) {
        mostrarEstado("error", "âŒ No se encontrÃ³ el cÃ³digo de la orden.");
        return;
      }

      const originalText = btnFinalizar.textContent;
      btnFinalizar.disabled = true;
      btnFinalizar.textContent = "Generando PDF...";
      mostrarEstado("info", "â³ Procesando orden, subiendo evidencias al servidor...");
      try {
        const materiales = document.getElementById("materiales").value.trim();
        const observaciones = document.getElementById("observaciones").value.trim();
        const cliente = document.getElementById("cliente").textContent;
        const telefono = document.getElementById("telefono").textContent;
        const tecnico = document.getElementById("tecnico").textContent;
        const estado = "Finalizada";
        const descripcion = document.getElementById("descripcion").textContent;
        const fotoAntes = document.getElementById("fotoAntes").files[0];
        const fotoDespues = document.getElementById("fotoDespues").files[0];
        const nombreFirmante = document.getElementById("nombreFirmante").value.trim();

        if (firmaTrazada && !nombreFirmante) {
          throw new Error("Debes escribir el nombre del firmante junto a la firma.");
        }

        const formData = new FormData();
        formData.append("codigo", codigo);
        formData.append("cliente", cliente);
        formData.append("telefono", telefono);
        formData.append("tecnico", tecnico);
        formData.append("estado", estado);
        formData.append("descripcion", descripcion);
        formData.append("materiales", materiales);
        formData.append("observaciones", observaciones);
        formData.append("nombreFirmante", nombreFirmante);
        if (fotoAntes) formData.append("fotoAntes", fotoAntes);
        if (fotoDespues) formData.append("fotoDespues", fotoDespues);

        if (firmaTrazada) {
          const firmaBlob = await new Promise((resolve, reject) => {
            canvas.toBlob((blob) => {
              if (blob) resolve(blob);
              else reject(new Error("No se pudo procesar la firma."));
            }, "image/png");
          });

          const firmaDataUrl = canvas.toDataURL("image/png");
          formData.append("firmaArchivo", firmaBlob, `firma_${codigo || "orden"}.png`);
          formData.append("firmaDataUrl", firmaDataUrl);
        }

        const res = await fetch(`${API}/${codigo}/pdf`, { method: "POST", body: formData });
        const out = await res.json();

        if (!res.ok || !out.ok) {
          throw new Error(out.error || "Error generando PDF");
        }

        const enlaces = [];
        if (out.driveUrl) enlaces.push(`<li><a href="${out.driveUrl}" target="_blank" rel="noopener">ğŸ“„ PDF generado</a></li>`);
        if (out.assets?.fotoAntes) enlaces.push(`<li><a href="${out.assets.fotoAntes}" target="_blank" rel="noopener">ğŸ“¸ Foto antes</a></li>`);
        if (out.assets?.fotoDespues) enlaces.push(`<li><a href="${out.assets.fotoDespues}" target="_blank" rel="noopener">ğŸ“¸ Foto despuÃ©s</a></li>`);
        if (out.assets?.firma) enlaces.push(`<li><a href="${out.assets.firma}" target="_blank" rel="noopener">âœï¸ Firma registrada</a></li>`);

        const mensaje = `âœ… ${out.message || "Orden finalizada correctamente."}`;
        const enlacesHtml = enlaces.length ? `<ul style="margin-top:8px;padding-left:18px;">${enlaces.join("")}</ul>` : "";
        mostrarEstado("success", `${mensaje}${enlacesHtml}`);

        setTimeout(() => { window.location.href = "ordenes.html"; }, 1200);
      } catch (e) {
        console.error(e);
        mostrarEstado("error", `âŒ ${e.message || "Error al generar PDF."}`);
      } finally {
        btnFinalizar.disabled = false;
        btnFinalizar.textContent = originalText;
      }
    });

    cargarOrden();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gesti√≥n de Orden | Blue Home Inmobiliaria</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #f4f6f8;
      margin: 0;
      padding: 20px;
      color: #1e3a8a;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    h2 {
      text-align: center;
      color: #1e3a8a;
    }
    .section {
      margin-top: 25px;
      border-top: 2px solid #1d4ed8;
      padding-top: 15px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
    }
    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 8px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background-color: #1d4ed8;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 15px;
      cursor: pointer;
      margin-right: 8px;
    }
    button:hover {
      background-color: #2563eb;
    }
    .row {
      display: flex;
      gap: 10px;
    }
    .row div {
      flex: 1;
    }
    .photo-preview {
      width: 100%;
      max-height: 250px;
      object-fit: cover;
      margin-top: 10px;
      border-radius: 6px;
    }
    canvas {
      border: 2px solid #1d4ed8;
      border-radius: 6px;
      width: 100%;
      height: 200px;
    }
    .success {
      background: #bbf7d0;
      color: #065f46;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .error {
      background: #fecaca;
      color: #991b1b;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>üß∞ Orden de Trabajo</h2>
    <div id="mensaje"></div>

    <div id="orden-info"></div>

    <div class="section">
      <h3>üì∏ Evidencias del trabajo</h3>
      <label>Foto Antes:</label>
      <input type="file" id="fotoAntes" accept="image/*" />
      <img id="previewAntes" class="photo-preview" />

      <label>Foto Despu√©s:</label>
      <input type="file" id="fotoDespues" accept="image/*" />
      <img id="previewDespues" class="photo-preview" />
    </div>

    <div class="section">
      <h3>üß± Materiales y Trabajo Realizado</h3>
      <label>Materiales Usados</label>
      <textarea id="materiales" placeholder="Ejemplo: pintura blanca, silicona, tornillos..."></textarea>

      <label>Descripci√≥n del Trabajo</label>
      <textarea id="trabajo" placeholder="Ejemplo: se instal√≥ el letrero, se sellaron juntas..."></textarea>

      <button id="btnGuardarFeedback">üíæ Guardar Retroalimentaci√≥n</button>
    </div>

    <div class="section">
      <h3>‚úçÔ∏è Firma del Inquilino</h3>
      <canvas id="firmaCanvas"></canvas><br />
      <button id="btnLimpiarFirma">üßπ Limpiar</button>
      <button id="btnGuardarFirma">üíæ Guardar Firma</button>
    </div>

    <div class="section" style="text-align:center;">
      <button id="btnFinalizar" style="background:#16a34a;">‚úÖ Marcar como Finalizada</button>
    </div>
  </div>

  <script>
    const API_BASE = "/api/orders";
    const urlParams = new URLSearchParams(window.location.search);
    const codigo = urlParams.get("codigo");
    const mensaje = document.getElementById("mensaje");
    const infoDiv = document.getElementById("orden-info");

    if (!codigo) {
      mensaje.innerHTML = '<div class="error">‚ö†Ô∏è No se proporcion√≥ el c√≥digo de la orden.</div>';
    } else {
      cargarOrden();
    }

    async function cargarOrden() {
      try {
        const res = await fetch(`${API_BASE}`);
        const data = await res.json();
        const orden = data.find(o => o.C√≥digo === codigo || o.codigo === codigo);
        if (!orden) {
          infoDiv.innerHTML = "<div class='error'>Orden no encontrada</div>";
          return;
        }

        infoDiv.innerHTML = `
          <p><b>C√≥digo:</b> ${orden.C√≥digo || orden.codigo}</p>
          <p><b>Arrendatario:</b> ${orden.Arrendatario || orden.arrendatario}</p>
          <p><b>T√©cnico:</b> ${orden.T√©cnico || orden.tecnico}</p>
          <p><b>Estado:</b> ${orden.Estado || orden.estado}</p>
          <p><b>Descripci√≥n:</b> ${orden.Descripci√≥n || orden.descripcion}</p>
        `;
      } catch (err) {
        infoDiv.innerHTML = "<div class='error'>Error al cargar orden.</div>";
      }
    }

    // FOTO ANTES
    document.getElementById("fotoAntes").addEventListener("change", async (e) => {
      await subirFoto(e.target.files[0], "antes", "previewAntes");
    });

    // FOTO DESPU√âS
    document.getElementById("fotoDespues").addEventListener("change", async (e) => {
      await subirFoto(e.target.files[0], "despues", "previewDespues");
    });

    async function subirFoto(file, tipo, previewId) {
      if (!file) return;
      const formData = new FormData();
      formData.append("file", file);
      formData.append("tipo", tipo);

      try {
        const res = await fetch(`${API_BASE}/${codigo}/upload-photo`, {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        if (data.ok) {
          document.getElementById(previewId).src = data.url;
          mostrarMensaje("‚úÖ Foto subida correctamente", "success");
        } else {
          mostrarMensaje("‚ùå Error al subir foto", "error");
        }
      } catch (err) {
        mostrarMensaje("‚ùå Error al subir foto", "error");
      }
    }

    // GUARDAR FEEDBACK
    document.getElementById("btnGuardarFeedback").addEventListener("click", async () => {
      const materiales = document.getElementById("materiales").value;
      const trabajo = document.getElementById("trabajo").value;

      const res = await fetch(`${API_BASE}/${codigo}/feedback`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ materiales, trabajo })
      });
      const data = await res.json();
      if (data.ok) mostrarMensaje("‚úÖ Retroalimentaci√≥n guardada", "success");
      else mostrarMensaje("‚ùå Error al guardar retroalimentaci√≥n", "error");
    });

    // FIRMA
    const canvas = document.getElementById("firmaCanvas");
    const ctx = canvas.getContext("2d");
    let dibujando = false;

    canvas.addEventListener("mousedown", e => { dibujando = true; ctx.beginPath(); });
    canvas.addEventListener("mouseup", e => dibujando = false);
    canvas.addEventListener("mousemove", dibujar);

    function dibujar(e) {
      if (!dibujando) return;
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "#1d4ed8";
      const rect = canvas.getBoundingClientRect();
      ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      ctx.stroke();
    }

    document.getElementById("btnLimpiarFirma").addEventListener("click", () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });

    document.getElementById("btnGuardarFirma").addEventListener("click", async () => {
      const dataUrl = canvas.toDataURL("image/png");
      const res = await fetch(`${API_BASE}/${codigo}/sign`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ firmaInquilino: dataUrl })
      });
      const data = await res.json();
      if (data.ok) mostrarMensaje("‚úÖ Firma guardada correctamente", "success");
      else mostrarMensaje("‚ùå Error al guardar firma", "error");
    });

    // FINALIZAR ORDEN
    document.getElementById("btnFinalizar").addEventListener("click", async () => {
      const res = await fetch(`${API_BASE}/${codigo}/finish`, { method: "POST" });
      const data = await res.json();
      if (data.ok) mostrarMensaje("‚úÖ Orden marcada como finalizada", "success");
      else mostrarMensaje("‚ùå Error al finalizar orden", "error");
    });

    function mostrarMensaje(texto, tipo) {
      mensaje.innerHTML = `<div class='${tipo}'>${texto}</div>`;
      setTimeout(() => (mensaje.innerHTML = ""), 3500);
    }
  </script>
</body>
</html>

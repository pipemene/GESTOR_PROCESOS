<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Orden de Trabajo | Blue Home Gestor</title>
  <link rel="stylesheet" href="assets/css/estilos.css" />
  <style>
    body { background-color: #f6f8fb; font-family: "Segoe UI", sans-serif; }
    header {
      background-color: #004aad; color: white;
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 30px;
    }
    .logo { height: 42px; }
    main { padding: 24px; max-width: 1000px; margin: 0 auto; }
    h2 { color: #004aad; margin: 10px 0 18px; }
    h3 { color: #004aad; margin: 0 0 14px; }

    .card {
      background: white; border-radius: 10px;
      padding: 18px; margin-bottom: 18px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px 18px; font-size: 15px;
    }
    .info-item b { color: #004aad; display:inline-block; min-width: 95px; }

    input[type="file"], input[type="text"], textarea {
      width: 100%; padding: 8px 10px; border: 1px solid #cfd6e4; border-radius: 8px;
      font-size: 14px; outline: none;
    }
    textarea { min-height: 90px; resize: vertical; }

    .btn {
      border: none; border-radius: 8px; padding: 9px 14px; cursor: pointer; font-weight: 600;
    }
    .btn-primary { background:#004aad; color:#fff; }
    .btn-primary:hover { background:#1f64d1; }
    .btn-muted { background:#6c757d; color:#fff; }
    .btn-muted:hover { background:#5a6268; }
    .btn-success { background:#2ecc71; color:#fff; }
    .btn-danger { background:#e74c3c; color:#fff; }

    /* Firma */
    .signature-wrap {
      border: 2px dashed #bfc6d8; border-radius: 10px; background:#fff;
      height: 220px; position: relative;
    }
    #firmaCanvas {
      width: 100%; height: 100%;
      border-radius: 8px;
      display:block; background: #ffffff;
    }
    .row-actions { display:flex; gap:10px; flex-wrap:wrap; }
    .hint { color:#6b7280; font-size: 12px; margin-top: 8px; }
  </style>
</head>

<body>
  <header>
    <div style="display:flex;align-items:center;gap:10px;">
      <img src="assets/img/logo-blanco.png" class="logo" alt="Blue Home" />
      <h2>Orden de Trabajo</h2>
    </div>
    <button class="btn btn-muted" id="btnBack">‚Üê Volver</button>
  </header>

  <main>
    <!-- INFO ORDEN -->
    <div class="card">
      <div class="info-grid">
        <div class="info-item"><b>C√≥digo:</b> <span id="codigo">‚Äî</span></div>
        <div class="info-item"><b>Arrendatario:</b> <span id="cliente">‚Äî</span></div>
        <div class="info-item"><b>Tel√©fono:</b> <span id="telefono">‚Äî</span></div>
        <div class="info-item"><b>T√©cnico:</b> <span id="tecnico">‚Äî</span></div>
        <div class="info-item"><b>Estado:</b> <span id="estado">‚Äî</span></div>
      </div>
      <p style="margin-top:12px;"><b>Descripci√≥n:</b> <span id="descripcion">‚Äî</span></p>
    </div>

    <!-- FOTOS -->
    <div class="card">
      <h3>üì∏ Evidencias del trabajo</h3>
      <div style="display:grid; grid-template-columns:1fr; gap:10px;">
        <div>
          <label><b>Foto Antes:</b></label>
          <input type="file" id="fotoAntes" accept="image/*"/>
        </div>
        <div>
          <label><b>Foto Despu√©s:</b></label>
          <input type="file" id="fotoDespues" accept="image/*"/>
        </div>
        <div class="row-actions">
          <button class="btn btn-primary" id="btnSubirFotos">üì§ Subir Fotos</button>
        </div>
        <div class="hint">Se suben a Drive y se guardan los enlaces en la orden.</div>
      </div>
    </div>

    <!-- RETROALIMENTACION -->
    <div class="card">
      <h3>ü™ö Materiales y Trabajo Realizado</h3>
      <textarea id="materiales" placeholder="Describe materiales o trabajos realizados..."></textarea>
      <textarea id="observaciones" placeholder="Observaciones o comentarios..."></textarea>
      <div class="row-actions">
        <button class="btn btn-primary" id="btnGuardarRetro">üíæ Guardar Retroalimentaci√≥n</button>
      </div>
    </div>

    <!-- FIRMA -->
    <div class="card">
      <h3>‚úçÔ∏è Firma del Inquilino</h3>
      <input type="text" id="nombreFirmante" placeholder="Nombre del firmante (Ej: Juan P√©rez)" />
      <div class="signature-wrap">
        <canvas id="firmaCanvas"></canvas>
      </div>
      <div class="row-actions" style="margin-top:10px;">
        <button class="btn btn-danger" id="btnLimpiarFirma">Limpiar</button>
        <button class="btn btn-primary" id="btnGuardarFirma">üíæ Guardar Firma</button>
      </div>
      <div class="hint">Firme con el dedo (m√≥vil) o con el mouse (PC). Si se equivoca, use ‚ÄúLimpiar‚Äù.</div>
    </div>

    <!-- FINALIZAR -->
    <div style="text-align:center; margin-top:18px;">
      <button class="btn btn-success" id="btnFinalizar">‚úÖ Finalizar Orden</button>
    </div>
  </main>

  <script>
    const API = "/api/orders";
    const params = new URLSearchParams(location.search);
    const fila = params.get("fila");
    const codigoParam = params.get("codigo");

    // NAV
    document.getElementById("btnBack").onclick = () => location.href = "ordenes.html";

    // ===== Carga de la orden =====
    async function cargarOrden() {
      try {
        // intentamos endpoint individual
        let data;
        try {
          const r1 = await fetch(\`\${API}/\${fila}\`);
          if (r1.ok) data = await r1.json();
        } catch {}

        // fallback: buscar en el listado
        if (!data || !data.C√≥digo) {
          const r2 = await fetch(API);
          const all = await r2.json();
          data = all.find(o => String(o.fila) === String(fila) || o.C√≥digo === codigoParam) || {};
        }

        // Mapear tolerando tildes / may√∫sculas
        const tel = data.Tel√©fono || data.Telefono || data.telefono || "‚Äî";
        const cli = data.Cliente || data.Inquilino || data.Arrendatario || "‚Äî";
        const cod = data.C√≥digo || data.codigo || codigoParam || "‚Äî";
        const est = data.Estado || data.estado || "‚Äî";
        const tec = data.T√©cnico || data.Tecnico || data.tecnico || "‚Äî";
        const des = data.Descripci√≥n || data.Descripcion || data.descripcion || "‚Äî";

        document.getElementById("telefono").textContent  = tel;
        document.getElementById("cliente").textContent   = cli;
        document.getElementById("codigo").textContent    = cod;
        document.getElementById("estado").textContent    = est;
        document.getElementById("tecnico").textContent   = tec;
        document.getElementById("descripcion").textContent = des;
      } catch (e) {
        console.error(e);
        alert("Error al cargar la orden.");
      }
    }

    // ===== FOTOS =====
    document.getElementById("btnSubirFotos").onclick = async () => {
      const antes = document.getElementById("fotoAntes").files[0];
      const despues = document.getElementById("fotoDespues").files[0];
      if (!antes && !despues) { alert("Selecciona al menos una foto."); return; }

      const fd = new FormData();
      if (antes)   fd.append("fotoAntes", antes);
      if (despues) fd.append("fotoDespues", despues);

      try {
        const res = await fetch(\`\${API}/\${fila}/photos\`, { method: "POST", body: fd });
        const out = await res.json();
        if (out.ok) alert("‚úÖ Fotos subidas correctamente.");
        else alert("‚ùå Error subiendo fotos.");
      } catch (e) {
        console.error(e); alert("Error subiendo fotos.");
      }
    };

    // ===== Retroalimentaci√≥n =====
    document.getElementById("btnGuardarRetro").onclick = async () => {
      const materiales    = document.getElementById("materiales").value.trim();
      const observaciones = document.getElementById("observaciones").value.trim();
      try {
        const res = await fetch(\`\${API}/update\`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fila, materiales, observaciones })
        });
        const out = await res.json();
        if (out.ok) alert("üíæ Retroalimentaci√≥n guardada.");
        else alert("‚ùå Error al guardar retroalimentaci√≥n.");
      } catch (e) {
        console.error(e); alert("Error al guardar retroalimentaci√≥n.");
      }
    };

    // ===== Firma =====
    const canvas = document.getElementById("firmaCanvas");
    const ctx = canvas.getContext("2d");
    function resizeCanvas() {
      // ajustar tama√±o al contenedor manteniendo nitidez
      const rect = canvas.parentElement.getBoundingClientRect();
      const ratio = window.devicePixelRatio || 1;
      canvas.width = rect.width * ratio;
      canvas.height = rect.height * ratio;
      canvas.style.width = rect.width + "px";
      canvas.style.height = rect.height + "px";
      ctx.scale(ratio, ratio);
      ctx.lineWidth = 2; ctx.lineCap = "round"; ctx.strokeStyle = "#111827";
    }
    resizeCanvas(); window.addEventListener("resize", resizeCanvas);

    let dibujando = false;
    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      if (e.touches && e.touches.length) e = e.touches[0];
      return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }
    function start(e){ dibujando = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); e.preventDefault(); }
    function draw(e){ if(!dibujando) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); }
    function end(){ dibujando = false; }

    canvas.addEventListener("mousedown", start);
    canvas.addEventListener("mousemove", draw);
    window.addEventListener("mouseup", end);
    canvas.addEventListener("touchstart", start, {passive:false});
    canvas.addEventListener("touchmove", draw, {passive:false});
    canvas.addEventListener("touchend", end);

    document.getElementById("btnLimpiarFirma").onclick = () => {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      resizeCanvas();
    };

    document.getElementById("btnGuardarFirma").onclick = async () => {
      const nombreFirmante = document.getElementById("nombreFirmante").value.trim();
      if (!nombreFirmante) { alert("Ingresa el nombre del firmante."); return; }
      const dataUrl = canvas.toDataURL("image/png"); // base64
      try {
        const res = await fetch(\`\${API}/\${fila}/sign\`, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ nombreFirmante, firmaData: dataUrl })
        });
        const out = await res.json();
        if (out.ok) alert("‚úÖ Firma guardada correctamente.");
        else alert("‚ùå Error al guardar la firma.");
      } catch(e){ console.error(e); alert("Error al guardar la firma."); }
    };

    // ===== Finalizar (con notificaci√≥n a Dayan desde backend) =====
    document.getElementById("btnFinalizar").onclick = async () => {
      if (!confirm("¬øFinalizar esta orden? Se notificar√° al √°rea de reparaciones.")) return;
      try {
        const res = await fetch(\`\${API}/\${fila}/finish\`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ notify: true }) // el backend usa esto para enviar correo a reparaciones@bluehomeinmo.co
        });
        const out = await res.json();
        if (out.ok) {
          alert("‚úÖ Orden finalizada. Se notific√≥ a Dayan (reparaciones@bluehomeinmo.co).");
          location.href = "ordenes.html";
        } else {
          alert("‚ùå No se pudo finalizar la orden.");
        }
      } catch (e) {
        console.error(e);
        alert("Error al finalizar la orden.");
      }
    };

    cargarOrden();
  </script>
</body>
</html>

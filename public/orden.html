<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Orden de Trabajo | Blue Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h4 class="text-primary fw-bold">üßæ Orden de Trabajo</h4>
      <button id="btnVolverDashboard" class="btn btn-secondary">‚Üê Volver al Dashboard</button>
    </div>

    <div id="ordenInfo" class="mb-4 p-3 bg-white rounded shadow-sm">
      <p><b>C√≥digo:</b> <span id="ordenCodigo"></span></p>
      <p><b>Arrendatario:</b> <span id="ordenArrendatario"></span></p>
      <p><b>T√©cnico:</b> <span id="ordenTecnico"></span></p>
      <p><b>Estado:</b> <span id="ordenEstado" class="badge bg-info"></span></p>
      <p><b>Descripci√≥n:</b> <span id="ordenDescripcion"></span></p>
    </div>

    <h5>üì∏ Evidencias del trabajo</h5>
    <div class="mb-3">
      <label>Foto Antes:</label>
      <input type="file" id="fotoAntes" class="form-control" accept="image/*" />
      <label class="mt-3">Foto Despu√©s:</label>
      <input type="file" id="fotoDespues" class="form-control" accept="image/*" />
      <button class="btn btn-outline-primary mt-3" onclick="subirFotos()">üì§ Subir Fotos</button>
    </div>

    <h5>üîß Materiales y Trabajo Realizado</h5>
    <textarea id="materiales" class="form-control mb-2" placeholder="Ejemplo: pintura blanca, silicona..."></textarea>
    <textarea id="descripcionTrabajo" class="form-control mb-3" placeholder="Ejemplo: se instal√≥ letrero, se sellaron juntas..."></textarea>
    <button class="btn btn-outline-success" onclick="guardarFeedback()">üíæ Guardar Retroalimentaci√≥n</button>

    <h5 class="mt-4">‚úçÔ∏è Firma del Inquilino</h5>
    <canvas id="firmaCanvas" width="400" height="150" class="border border-secondary bg-white rounded mb-2"></canvas><br>
    <button class="btn btn-sm btn-danger" onclick="limpiarFirma()">Limpiar</button>
    <button class="btn btn-sm btn-primary" onclick="guardarFirma()">Guardar Firma</button>

    <div class="text-center mt-4">
      <button class="btn btn-success btn-lg" onclick="finalizarOrden()">‚úÖ Finalizar Orden</button>
    </div>
  </div>

  <script>
    const codigo = localStorage.getItem("ordenActual");

    document.getElementById("btnVolverDashboard").addEventListener("click", () => {
      window.location.href = "dashboard.html";
    });

    async function subirFotos() {
      const antes = document.getElementById("fotoAntes").files[0];
      const despues = document.getElementById("fotoDespues").files[0];
      if (!antes && !despues) return alert("Selecciona al menos una foto.");

      const formData = new FormData();
      if (antes) formData.append("file", antes);
      if (antes) formData.append("tipo", "antes");
      await fetch(`/api/orders/${codigo}/upload-photo`, { method: "POST", body: formData });

      const formData2 = new FormData();
      if (despues) formData2.append("file", despues);
      if (despues) formData2.append("tipo", "despues");
      await fetch(`/api/orders/${codigo}/upload-photo`, { method: "POST", body: formData2 });

      alert("üì∏ Fotos subidas correctamente");
    }

    async function guardarFeedback() {
      const materiales = document.getElementById("materiales").value;
      const trabajo = document.getElementById("descripcionTrabajo").value;
      await fetch(`/api/orders/${codigo}/feedback`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ materiales, trabajo })
      });
      alert("‚úÖ Informaci√≥n guardada");
    }

    function limpiarFirma() {
      const canvas = document.getElementById("firmaCanvas");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    async function guardarFirma() {
      const canvas = document.getElementById("firmaCanvas");
      const firma = canvas.toDataURL("image/png");
      await fetch(`/api/orders/${codigo}/sign`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ firmaInquilino: firma })
      });
      alert("‚úçÔ∏è Firma guardada correctamente");
    }

    async function finalizarOrden() {
      if (!confirm("¬øSeguro que deseas finalizar esta orden?")) return;
      const res = await fetch(`/api/orders/${codigo}/finish`, { method: "POST" });
      const data = await res.json();

      if (data.ok) {
        alert("‚úÖ Orden finalizada con √©xito.");
        window.location.href = "dashboard.html"; // üîÅ Regresa al dashboard
      } else {
        alert("‚ùå Error al finalizar la orden");
      }
    }
  </script>
</body>
</html>

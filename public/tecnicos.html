<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T√©cnicos | Blue Home Gestor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { background-color: #eef3f8; font-family: 'Segoe UI', sans-serif; }
    header {
      background: linear-gradient(90deg, #003366 0%, #005fa3 100%);
      color: white;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo { width: 45px; margin-right: 10px; }
    .card { border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); }
    .foto-prev { width: 100%; max-height: 200px; object-fit: cover; border-radius: 10px; margin-top: 10px; }
    footer { background-color: #003366; color: white; text-align: center; padding: 10px; font-size: 0.9em; }
  </style>
</head>

<body>
  <header>
    <div class="d-flex align-items-center">
      <img src="https://i.imgur.com/FEBvZ6N.png" alt="Logo Blue Home" class="logo">
      <h4 class="mb-0">Panel de T√©cnicos ‚Äî Blue Home</h4>
    </div>
    <div>
      <button class="btn btn-sm btn-light me-2" onclick="volver()">üè† Dashboard</button>
      <span id="usuarioInfo" class="fw-semibold me-2"></span>
      <button class="btn btn-sm btn-danger" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
    </div>
  </header>

  <main class="container mt-4">
    <div class="text-center mb-3">
      <h5 class="text-primary">üß∞ √ìrdenes Asignadas</h5>
      <p class="text-muted">Sube tus evidencias y marca las √≥rdenes como finalizadas</p>
    </div>

    <div id="listaOrdenes" class="row g-3"></div>
  </main>

  <footer>
    Blue Home Inmobiliaria ¬© 2025 ‚Äî M√≥dulo T√©cnico
  </footer>

  <script>
    const usuario = JSON.parse(localStorage.getItem("usuarioActivo") || "{}");
    if (!usuario.nombre) window.location.href = "index.html";

    document.getElementById("usuarioInfo").textContent =
      `${usuario.nombre.toUpperCase()} (${usuario.rol.toUpperCase()})`;

    function volver() { window.location.href = "dashboard.html"; }
    function cerrarSesion() { localStorage.clear(); window.location.href = "index.html"; }

    // üîπ Cargar √≥rdenes asignadas al t√©cnico
    async function cargarOrdenes() {
      const res = await fetch("/api/orders");
      const data = await res.json();
      const lista = document.getElementById("listaOrdenes");
      lista.innerHTML = "";

      const asignadas = data.filter(o =>
        o.tecnico?.toLowerCase() === usuario.nombre.toLowerCase()
      );

      if (asignadas.length === 0) {
        lista.innerHTML = `<div class="col-12 text-center text-muted">No tienes √≥rdenes asignadas actualmente.</div>`;
        return;
      }

      asignadas.forEach(o => {
        const card = document.createElement("div");
        card.className = "col-md-6";
        card.innerHTML = `
          <div class="card p-3">
            <h6 class="text-primary">üîπ Orden ${o.codigo}</h6>
            <p><b>Arrendatario:</b> ${o.arrendatario || "‚Äî"}</p>
            <p><b>Descripci√≥n:</b> ${o.descripcion || "Sin descripci√≥n"}</p>

            <hr>
            <div>
              <label class="form-label fw-semibold">üì∏ Foto Antes</label>
              <input type="file" class="form-control form-control-sm" accept="image/*" onchange="subirFoto('${o.codigo}', this, 'antes')">
              <img id="prev_antes_${o.codigo}" class="foto-prev d-none" />
            </div>

            <div class="mt-2">
              <label class="form-label fw-semibold">üì∏ Foto Despu√©s</label>
              <input type="file" class="form-control form-control-sm" accept="image/*" onchange="subirFoto('${o.codigo}', this, 'despues')">
              <img id="prev_despues_${o.codigo}" class="foto-prev d-none" />
            </div>

            <div class="mt-3">
              <label class="form-label fw-semibold">üßæ Materiales utilizados</label>
              <textarea id="mat_${o.codigo}" class="form-control" rows="2" placeholder="Ej: Pintura, tornillos, cinta, etc."></textarea>
            </div>

            <div class="mt-3">
              <label class="form-label fw-semibold">ü™ö Trabajo realizado</label>
              <textarea id="trab_${o.codigo}" class="form-control" rows="2" placeholder="Ej: Reparaci√≥n de puerta, pintura de pared, etc."></textarea>
            </div>

            <div class="mt-3">
              <label class="form-label fw-semibold">‚úçÔ∏è Firma del inquilino</label>
              <canvas id="firma_${o.codigo}" width="300" height="120" style="border:1px solid #ccc; border-radius:10px; background:white;"></canvas><br>
              <button class="btn btn-sm btn-secondary mt-1" onclick="limpiarFirma('${o.codigo}')">üßπ Limpiar</button>
              <button class="btn btn-sm btn-success mt-1" onclick="guardarFirma('${o.codigo}')">üíæ Guardar Firma</button>
            </div>

            <hr>
            <button class="btn btn-primary w-100 mt-2" onclick="finalizarOrden('${o.codigo}')">‚úÖ Finalizar Orden</button>
          </div>
        `;
        lista.appendChild(card);
        inicializarCanvas(o.codigo);
      });
    }

    // üé® Control de firmas
    const firmas = {};
    function inicializarCanvas(codigo) {
      const canvas = document.getElementById(`firma_${codigo}`);
      const ctx = canvas.getContext("2d");
      let dibujando = false;

      canvas.addEventListener("mousedown", e => {
        dibujando = true;
        ctx.beginPath();
        ctx.moveTo(e.offsetX, e.offsetY);
      });

      canvas.addEventListener("mousemove", e => {
        if (!dibujando) return;
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.strokeStyle = "#000";
        ctx.lineWidth = 2;
        ctx.stroke();
      });

      canvas.addEventListener("mouseup", () => (dibujando = false));
      canvas.addEventListener("mouseleave", () => (dibujando = false));

      firmas[codigo] = canvas;
    }

    function limpiarFirma(codigo) {
      const ctx = firmas[codigo].getContext("2d");
      ctx.clearRect(0, 0, firmas[codigo].width, firmas[codigo].height);
    }

    async function guardarFirma(codigo) {
      const dataURL = firmas[codigo].toDataURL("image/png");
      const res = await fetch(`/api/orders/${codigo}/sign`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ firmaInquilino: dataURL })
      });

      if (res.ok) Swal.fire("‚úÖ Firma guardada", "", "success");
      else Swal.fire("‚ö†Ô∏è Error al guardar firma", "", "error");
    }

    // üì∑ Subir fotos antes/despu√©s
    async function subirFoto(codigo, input, tipo) {
      const file = input.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append("file", file);
      formData.append("tipo", tipo);

      const res = await fetch(`/api/orders/${codigo}/upload-photo`, {
        method: "POST",
        body: formData
      });

      const prev = document.getElementById(`prev_${tipo}_${codigo}`);
      const data = await res.json();
      if (res.ok) {
        prev.src = data.url;
        prev.classList.remove("d-none");
        Swal.fire("üì∏ Imagen subida correctamente", "", "success");
      } else {
        Swal.fire("‚ö†Ô∏è Error al subir la foto", data.error || "", "error");
      }
    }

    // ‚úÖ Finalizar orden
    async function finalizarOrden(codigo) {
      const materiales = document.getElementById(`mat_${codigo}`).value;
      const trabajo = document.getElementById(`trab_${codigo}`).value;

      await fetch(`/api/orders/${codigo}/feedback`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ materiales, trabajo })
      });

      const res = await fetch(`/api/orders/${codigo}/finish`, { method: "POST" });
      if (res.ok) {
        Swal.fire("‚úÖ Orden finalizada correctamente", "", "success");
        cargarOrdenes();
      } else {
        Swal.fire("‚ö†Ô∏è Error al finalizar la orden", "", "error");
      }
    }

    cargarOrdenes();
  </script>
</body>
</html>

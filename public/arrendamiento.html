<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>√Årea de Arrendamientos | Blue Home Gestor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background-color: #eef3f8; font-family: 'Segoe UI', sans-serif; }
    header { background-color: #003366; color: white; padding: 10px 20px;
             display: flex; justify-content: space-between; align-items: center; }
    .btn-primary { background-color: #006bb3; border: none; }
    .btn-primary:hover { background-color: #004c80; }
    .card { border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  </style>
</head>

<body>
  <header>
    <h5>üè¢ √Årea de Arrendamientos ‚Äî Blue Home</h5>
    <div>
      <button class="btn btn-sm btn-light me-2" onclick="volver()">üè† Dashboard</button>
      <span id="usuarioInfo" class="fw-semibold me-2"></span>
      <button class="btn btn-sm btn-danger" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
    </div>
  </header>

  <main class="container mt-4">
    <h4 class="text-primary mb-3">Gesti√≥n de √ìrdenes</h4>

    <div class="card p-4 mb-4">
      <h5 class="text-success">‚ûï Crear Nueva Orden</h5>
      <form id="formOrden" class="mt-3">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">C√≥digo</label>
            <input type="text" class="form-control" id="codigo" required />
          </div>
          <div class="col-md-4">
            <label class="form-label">Arrendatario</label>
            <input type="text" class="form-control" id="arrendatario" required />
          </div>
          <div class="col-md-3">
            <label class="form-label">Tel√©fono</label>
            <input type="text" class="form-control" id="telefono" required />
          </div>
          <div class="col-md-4">
            <label class="form-label">T√©cnico asignado</label>
            <input type="text" class="form-control" id="tecnico" placeholder="Ej. Jair" />
          </div>
          <div class="col-md-8">
            <label class="form-label">Descripci√≥n / Observaciones</label>
            <textarea class="form-control" id="descripcion" rows="3" required></textarea>
          </div>
        </div>
        <button type="submit" class="btn btn-success mt-3">Guardar Orden</button>
      </form>
      <div id="msg" class="mt-3 fw-semibold"></div>
    </div>

    <div class="card p-4">
      <h5 class="text-primary">üìã √ìrdenes Existentes</h5>
      <table class="table table-bordered text-center mt-3">
        <thead class="table-secondary">
          <tr>
            <th>C√≥digo</th>
            <th>Arrendatario</th>
            <th>T√©cnico</th>
            <th>Estado</th>
            <th>Descripci√≥n</th>
          </tr>
        </thead>
        <tbody id="tablaOrdenes"></tbody>
      </table>
    </div>
  </main>

  <script>
    const usuario = JSON.parse(localStorage.getItem("usuarioActivo") || "{}");
    if (!usuario.nombre || !["arrendamiento", "admin"].includes(usuario.rol.toLowerCase())) {
      alert("‚ö†Ô∏è Acceso restringido al √°rea de arrendamientos.");
      window.location.href = "index.html";
    }
    document.getElementById("usuarioInfo").textContent =
      `${usuario.nombre.toUpperCase()} (${usuario.rol.toUpperCase()})`;

    function volver() { window.location.href = "dashboard.html"; }
    function cerrarSesion() { localStorage.clear(); window.location.href = "index.html"; }

    // üîπ Crear nueva orden
    document.getElementById("formOrden").addEventListener("submit", async (e) => {
      e.preventDefault();
      const datos = {
        codigo: codigo.value.trim(),
        arrendatario: arrendatario.value.trim(),
        telefono: telefono.value.trim(),
        tecnico: tecnico.value.trim(),
        descripcion: descripcion.value.trim()
      };
      const msg = document.getElementById("msg");

      try {
        const res = await fetch("/api/orders", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(datos)
        });
        const data = await res.json();
        if (data.ok) {
          msg.innerHTML = "‚úÖ Orden creada exitosamente.";
          msg.classList.add("text-success");
          e.target.reset();
          cargarOrdenes();
        } else {
          msg.innerHTML = "‚ö†Ô∏è Error al crear la orden.";
          msg.classList.add("text-danger");
        }
      } catch (err) {
        msg.innerHTML = "‚ùå No se pudo conectar con el servidor.";
        msg.classList.add("text-danger");
      }
    });

    // üîπ Cargar √≥rdenes
    async function cargarOrdenes() {
      const res = await fetch("/api/orders");
      const data = await res.json();
      const tbody = document.getElementById("tablaOrdenes");
      tbody.innerHTML = "";
      data.forEach(o => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${o.C√≥digo || o.codigo}</td>
          <td>${o.Arrendatario || o.arrendatario}</td>
          <td>${o.T√©cnico || o.tecnico}</td>
          <td>${o.Estado || o.estado}</td>
          <td>${o.Descripci√≥n || o.descripcion}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    cargarOrdenes();
  </script>
</body>
</html>

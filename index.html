<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Gestor de Procesos ‚Äì Blue Home</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1729;
      --card:#111a2b;
      --muted:#9fb0d4;
      --accent:#3aa0ff;
      --ok:#22c55e;
      --err:#ef4444;
      --text:#e8eefb;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(45deg,#0b1220,#0e1426);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,sans-serif}
    .app{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    .sidebar{background:var(--panel);border-right:1px solid #1b2542;padding:18px 14px;position:sticky;top:0;height:100vh}
    .brand{display:flex;gap:10px;align-items:center;margin-bottom:16px}
    .brand img{width:28px;height:28px}
    .brand .title{font-weight:800;letter-spacing:.3px}
    nav{display:flex;flex-direction:column;gap:6px;margin-top:10px}
    .nav-btn{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;border:1px solid #1a2744;background:#0d1628;color:#cfe0ff;cursor:pointer;text-decoration:none}
    .nav-btn.active{background:#10203a;border-color:#2a4c89;color:#fff}
    .nav-footer{position:absolute;bottom:12px;left:14px;right:14px;color:var(--muted);font-size:12px}
    header.top{padding:16px;border-bottom:1px solid #1b2542;background:#0c1323;position:sticky;top:0;z-index:5}
    .wrap{padding:18px;max-width:1200px}
    h1{margin:0;font-size:20px}
    .grid{display:grid;gap:16px}
    @media (min-width:980px){ .grid-2{grid-template-columns:1fr 1fr} .grid-3{grid-template-columns:1fr 1fr 1fr} }
    .card{background:var(--card);border:1px solid #1a2744;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    label{font-size:12px;color:var(--muted)}
    input,textarea,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #213054;background:#0e172b;color:var(--text);outline:none}
    input:focus,textarea:focus,select:focus{border-color:#325aa7;box-shadow:0 0 0 3px rgba(58,160,255,.15)}
    button{cursor:pointer;background:linear-gradient(180deg,#2b85f6,#2769da);border:none;font-weight:700}
    button.secondary{background:#17233d}
    .row{display:flex;gap:10px;align-items:center}
    .row>*{flex:1}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px;border-bottom:1px solid #1a2744;text-align:left;color:#dbe7ff}
    th{color:#9fb0d4;font-weight:600}
    .status{font-size:13px;margin-top:6px}
    .ok{color:var(--ok)} .err{color:var(--err)} .muted{color:var(--muted)}
    .hide{display:none !important}
    .pill{display:inline-flex;gap:8px;align-items:center;background:#0f1a30;border:1px solid #1c2d52;padding:6px 10px;border-radius:999px;font-size:12px;color:#c9d7f3}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <img src="logo.svg" alt="Blue Home logo"/>
        <div>
          <div class="title">BLUE HOME</div>
          <div style="color:#9fb0d4;font-size:12px">Gestor de Procesos v1</div>
        </div>
      </div>
      <nav>
        <a class="nav-btn active" data-view="view-ordenes">üßæ √ìrdenes</a>
        <a class="nav-btn" data-view="view-usuarios">üë• Usuarios</a>
        <a class="nav-btn" data-view="view-reportes">üìà Reportes</a>
        <a class="nav-btn" data-view="view-config">‚öôÔ∏è Configuraci√≥n</a>
        <a class="nav-btn" id="btnLogout">üö™ Cerrar sesi√≥n</a>
      </nav>
      <div class="nav-footer">¬© Blue Home Inmobiliaria</div>
    </aside>

    <main>
      <header class="top">
        <div class="row" style="justify-content:space-between">
          <h1 id="topTitle">Panel</h1>
          <div class="pill" id="sessionInfo">Sin sesi√≥n</div>
        </div>
      </header>

      <div class="wrap">
        <!-- LOGIN -->
        <section class="card" id="view-login">
          <h2>Iniciar sesi√≥n</h2>
          <div class="grid grid-2">
            <div>
              <label>Usuario</label>
              <input id="lUsuario" placeholder="Ej. ARRENDAMIENTO"/>
            </div>
            <div>
              <label>Clave</label>
              <input id="lClave" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <button id="btnLogin">Ingresar</button>
            <button class="secondary" id="btnPing">Probar conexi√≥n</button>
          </div>
          <div id="loginStatus" class="status"></div>
        </section>

        <!-- √ìRDENES -->
        <section id="view-ordenes" class="hide">
          <div class="grid grid-2">
            <div class="card">
              <h2>Nueva orden</h2>
              <div class="grid">
                <div class="row">
                  <div><label>Inquilino</label><input id="oInquilino"/></div>
                  <div><label>Tel√©fono</label><input id="oTelefono"/></div>
                </div>
                <div class="row">
                  <div><label>C√≥digo</label><input id="oCodigo"/></div>
                  <div><label>Prioridad</label>
                    <select id="oPrioridad">
                      <option>Alta</option><option selected>Media</option><option>Baja</option>
                    </select>
                  </div>
                </div>
                <div><label>Descripci√≥n</label><textarea id="oDescripcion" rows="4"></textarea></div>
                <div class="row">
                  <div><label>T√©cnico</label><input id="oTecnico" placeholder="MAURICIO / DAYAN / JAIR"/></div>
                  <div><label>Estado</label>
                    <select id="oEstado"><option>Pendiente</option><option>En curso</option><option>Cerrado</option></select>
                  </div>
                </div>
                <button id="btnCrearOrden">Crear orden</button>
                <div id="ordenStatus" class="status"></div>
              </div>
            </div>

            <div class="card">
              <h2>Mis √≥rdenes</h2>
              <div class="row">
                <button id="btnCargarOrdenes">Cargar</button>
              </div>
              <div class="status muted" id="listInfo"></div>
              <table id="tablaOrdenes" class="hide">
                <thead>
                  <tr>
                    <th>Radicado</th><th>Fecha</th><th>Inquilino</th><th>Tel√©fono</th><th>C√≥digo</th><th>Descripci√≥n</th><th>T√©cnico</th><th>Estado</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- USUARIOS -->
        <section id="view-usuarios" class="card hide">
          <h2>Usuarios (vista informativa)</h2>
          <p class="muted">M√≥dulo habilitado. En pr√≥ximas versiones se gestionar√° desde aqu√≠ la hoja <b>Usuarios</b>.</p>
        </section>

        <!-- REPORTES -->
        <section id="view-reportes" class="card hide">
          <h2>Reportes</h2>
          <p class="muted">M√≥dulo habilitado. Pr√≥ximamente: filtros por estado, t√©cnico y fecha; exportaci√≥n a CSV/PDF.</p>
        </section>

        <!-- CONFIG -->
        <section id="view-config" class="card hide">
          <h2>Configuraci√≥n</h2>
          <p class="muted">Aqu√≠ podr√°s configurar t√©cnicos visibles y otras preferencias. (Placeholder)</p>
        </section>
      </div>
    </main>
  </div>

  <script>
    // ---------- Navegaci√≥n ----------
    const sections = ["view-login","view-ordenes","view-usuarios","view-reportes","view-config"];
    const navBtns = document.querySelectorAll(".nav-btn");
    function show(view){
      sections.forEach(id => document.getElementById(id)?.classList.add("hide"));
      document.getElementById(view)?.classList.remove("hide");
      navBtns.forEach(b => b.classList.toggle("active", b.dataset.view===view));
      const mapTitle = {
        "view-login":"Iniciar sesi√≥n","view-ordenes":"√ìrdenes","view-usuarios":"Usuarios","view-reportes":"Reportes","view-config":"Configuraci√≥n"
      };
      document.getElementById("topTitle").textContent = mapTitle[view] || "Panel";
    }
    navBtns.forEach(b => b.addEventListener("click", () => {
      const view = b.dataset.view;
      if(view) show(view);
    }));
    document.getElementById("btnLogout").addEventListener("click", () => {
      session = null;
      document.getElementById("sessionInfo").textContent = "Sin sesi√≥n";
      show("view-login");
    });

    // ---------- Sesi√≥n ----------
    let session = null; // { usuario, rol }

    function guardByRole(){
      // SuperAdmin: todo / Admin: todo excepto Config avanzado (a futuro) / Tecnico: solo listado
      const isLogged = !!session;
      document.getElementById("btnCrearOrden").disabled = !(isLogged && (session.rol==="SuperAdmin" || session.rol==="admin"));
      document.getElementById("oTecnico").disabled = !(isLogged && (session.rol==="SuperAdmin" || session.rol==="admin"));
      // T√©cnicos no pueden crear
      if(session?.rol==="tecnico"){
        document.getElementById("oEstado").disabled = true;
      } else {
        document.getElementById("oEstado").disabled = false;
      }
    }

    // ---------- API ----------
    async function api(path, body){
      const res = await fetch(path, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body||{})
      });
      const data = await res.json();
      if(!res.ok || data.status!=="ok") throw new Error(data.message || "Error en API");
      return data.data;
    }

    // Test de conexi√≥n
    document.getElementById("btnPing").addEventListener("click", async () => {
      const el = document.getElementById("loginStatus");
      try{
        const res = await fetch("/api/test");
        const json = await res.json();
        el.textContent = json.ok ? "Conexi√≥n OK. GAS_URL " + (json.env.GAS_URL_present ? "presente" : "faltante") : "Fallo test";
        el.className = "status " + (json.ok ? "ok":"err");
      }catch(e){
        el.textContent = e.message; el.className="status err";
      }
    });

    // Login
    document.getElementById("btnLogin").addEventListener("click", async () => {
      const usuario = document.getElementById("lUsuario").value.trim();
      const clave = document.getElementById("lClave").value;
      const el = document.getElementById("loginStatus");
      try{
        const data = await api("/api/login", { usuario, clave });
        session = data; // {usuario, rol}
        el.textContent = "Sesi√≥n iniciada como " + session.usuario + " (" + session.rol + ")";
        el.className = "status ok";
        document.getElementById("sessionInfo").textContent = session.usuario + " ¬∑ " + session.rol;
        show("view-ordenes");
        guardByRole();
      }catch(e){
        el.textContent = e.message; el.className="status err";
      }
    });

    // Crear orden
    document.getElementById("btnCrearOrden").addEventListener("click", async () => {
      const el = document.getElementById("ordenStatus");
      try{
        if(!session) throw new Error("Inicia sesi√≥n primero");
        const payload = {
          usuario: session.usuario,
          inquilino: document.getElementById("oInquilino").value.trim(),
          telefono: document.getElementById("oTelefono").value.trim(),
          codigo: document.getElementById("oCodigo").value.trim(),
          descripcion: document.getElementById("oDescripcion").value.trim(),
          tecnico: document.getElementById("oTecnico").value.trim(),
          prioridad: document.getElementById("oPrioridad").value,
          estado: document.getElementById("oEstado").value
        };
        if(!payload.descripcion) throw new Error("Escribe una descripci√≥n");
        const data = await api("/api/createOrder", payload);
        el.textContent = "Orden creada: " + data.radicado;
        el.className = "status ok";
      }catch(e){
        el.textContent = e.message; el.className="status err";
      }
    });

    // Listar √≥rdenes
    const tabla = document.getElementById("tablaOrdenes");
    const tbody = tabla.querySelector("tbody");
    document.getElementById("btnCargarOrdenes").addEventListener("click", async () => {
      const info = document.getElementById("listInfo");
      tbody.innerHTML = "";
      try{
        if(!session) throw new Error("Inicia sesi√≥n primero");
        const rows = await api("/api/listOrders", { usuario: session.usuario, rol: session.rol });
        if(!rows.length){ info.textContent="Sin √≥rdenes"; info.className="status muted"; tabla.classList.add("hide"); return; }
        rows.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${r.radicado||""}</td><td>${r.fecha||""}</td><td>${r.inquilino||""}</td><td>${r.telefono||""}</td><td>${r.codigo||""}</td><td>${r.descripcion||""}</td><td>${r.tecnico||""}</td><td>${r.estado||""}</td>`;
          tbody.appendChild(tr);
        });
        info.textContent = rows.length + " registros"; info.className="status muted";
        tabla.classList.remove("hide");
      }catch(e){
        info.textContent = e.message; info.className="status err"; tabla.classList.add("hide");
      }
    });
  </script>
</body>
</html>
